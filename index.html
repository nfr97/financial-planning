<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Planner v5.2 (UI Fix)</title>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-green: #4ade80;
            --accent-red: #f87171;
            --accent-yellow: #facc15;
            --border: #334155;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); padding: 20px; font-size: 15px; line-height: 1.5; }

        .container { max-width: 1000px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 1.8rem; letter-spacing: -0.5px; margin-bottom: 5px; }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; }

        .layout-grid { display: grid; grid-template-columns: 320px 1fr; gap: 24px; align-items: start; }
        @media (max-width: 850px) { .layout-grid { grid-template-columns: 1fr; } }

        .card { background: var(--panel-bg); border-radius: 16px; padding: 24px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .section-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--accent-blue); font-weight: bold; margin-bottom: 16px; display: block; }
        
        .input-wrapper { margin-bottom: 16px; }
        .input-label { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 6px; }
        .input-control { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 10px 12px; border-radius: 8px; font-size: 1rem; transition: border 0.2s; }
        .input-control:focus { outline: none; border-color: var(--accent-blue); }
        .input-control.slider { height: 6px; padding: 0; accent-color: var(--accent-blue); background: var(--border); border: none; margin-top: 8px; }

        .hero-stats { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .big-percent { font-size: 3.5rem; font-weight: 800; line-height: 1; letter-spacing: -2px; }
        .hero-text { flex: 1; font-size: 0.95rem; color: #e2e8f0; }

        .chart-box { height: 350px; width: 100%; background: #1e293b; border-radius: 12px; overflow: hidden; position: relative; }
        canvas { width: 100%; height: 100%; display: block; }

        .adv-toggle-btn { 
            width: 100%; background: transparent; border: 1px dashed var(--border); color: var(--text-muted); 
            padding: 12px; border-radius: 8px; margin-top: 20px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
        }
        .adv-toggle-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        
        .advanced-panel { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); animation: slideDown 0.3s ease; }
        .advanced-panel.open { display: block; }

        .sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .small-input-group label { font-size: 0.75rem; color: var(--text-muted); }
        .small-input { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: white; padding: 6px; border-radius: 4px; font-size: 0.85rem; text-align: right; }

        /* Updated Event Row Styling (Grid for inputs) */
        .event-row { display: grid; grid-template-columns: 1fr 60px 50px 70px 20px; gap: 5px; align-items: center; margin-bottom: 6px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 6px; }
        .event-row select, .event-row input { background: #0f172a; border: 1px solid #334155; color: white; padding: 4px; border-radius: 4px; font-size: 0.75rem; width: 100%; }
        .event-row.income { border-left: 2px solid var(--accent-green); }
        .event-row.expense { border-left: 2px solid var(--accent-red); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .badge { background: var(--accent-green); color: #064e3b; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 8px; vertical-align: middle; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Retirement Planner <span class="badge">v5.2 UI Fix</span></h1>
        <div class="subtitle">Secure, private, and professional-grade financial modeling.</div>
    </header>

    <div class="layout-grid">
        <!-- CONTROLS COLUMN -->
        <div class="controls-col">
            <div class="card">
                <span class="section-label">Basic Inputs</span>
                
                <!-- Simple Inputs -->
                <div class="input-wrapper">
                    <div class="input-label"><span>Current Age</span> <span id="lbl-age" style="color:white; font-weight:bold;">35</span></div>
                    <input type="range" id="age" min="20" max="80" value="35" class="input-control slider">
                </div>

                <div class="input-wrapper">
                    <div class="input-label"><span>Retirement Age</span> <span id="lbl-ret" style="color:white; font-weight:bold;">65</span></div>
                    <input type="range" id="retAge" min="40" max="95" value="65" class="input-control slider">
                </div>

                <div class="input-wrapper">
                    <div class="input-label"><span>Total Savings</span></div>
                    <input type="text" id="simpleTotalSavings" value="135,000" class="input-control">
                </div>

                <div class="input-wrapper">
                    <div class="input-label"><span>Monthly Contribution</span></div>
                    <input type="text" id="simpleMonthlySave" value="2,000" class="input-control">
                </div>

                <div class="input-wrapper">
                    <div class="input-label"><span>Monthly Spending Goal</span></div>
                    <input type="text" id="spend" value="6,500" class="input-control">
                </div>

                <!-- Advanced Toggle -->
                <button class="adv-toggle-btn" onclick="toggleAdvanced()">
                    ⚙️ Advanced Settings
                </button>

                <!-- ADVANCED PANEL (Hidden by default) -->
                <div id="advPanel" class="advanced-panel">
                    
                    <span class="section-label">1. Portfolio Breakdown</span>
                    <div class="sub-grid" style="margin-bottom:15px;">
                        <div class="small-input-group">
                            <label style="color:var(--accent-blue)">Taxable</label>
                            <input type="text" id="balTaxable" class="small-input" value="20,000">
                        </div>
                        <div class="small-input-group">
                            <label style="color:var(--accent-blue)">Mo. Add</label>
                            <input type="text" id="conTaxable" class="small-input" value="500">
                        </div>
                        
                        <div class="small-input-group">
                            <label style="color:var(--accent-yellow)">401k/IRA</label>
                            <input type="text" id="balDeferred" class="small-input" value="100,000">
                        </div>
                        <div class="small-input-group">
                            <label style="color:var(--accent-yellow)">Mo. Add</label>
                            <input type="text" id="conDeferred" class="small-input" value="1,500">
                        </div>

                        <div class="small-input-group">
                            <label style="color:var(--accent-green)">Roth/HSA</label>
                            <input type="text" id="balRoth" class="small-input" value="15,000">
                        </div>
                        <div class="small-input-group">
                            <label style="color:var(--accent-green)">Mo. Add</label>
                            <input type="text" id="conRoth" class="small-input" value="0">
                        </div>
                    </div>

                    <span class="section-label">2. Strategy & Assumptions</span>
                    <div class="input-wrapper">
                        <div class="input-label"><span>Stock Allocation</span> <span id="lbl-alloc">80%</span></div>
                        <input type="range" id="alloc" min="0" max="100" step="5" value="80" class="input-control slider">
                    </div>
                    
                    <div class="input-wrapper">
                        <div class="input-label"><span>Spending Flexibility</span></div>
                        <select id="flexRule" class="input-control" style="font-size:0.85rem;">
                            <option value="none">Rigid (Never Adjust)</option>
                            <option value="flexible_10">Flexible (Cut 10% in crash)</option>
                            <option value="flexible_20">Aggressive (Cut 20% in crash)</option>
                        </select>
                    </div>

                    <div class="sub-grid">
                        <div class="small-input-group">
                            <label>SS Start Age</label>
                            <input type="text" id="ssAge" class="small-input" value="67">
                        </div>
                        <div class="small-input-group">
                            <label>SS Benefit</label>
                            <input type="text" id="ssAmt" class="small-input" value="2,800">
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <span class="section-label" style="display:flex; justify-content:space-between; align-items:center;">
                            Life Events <button style="background:none; border:none; color:var(--accent-blue); cursor:pointer;" onclick="addEventUI()">+ Add</button>
                        </span>
                        
                        <!-- Event Headers -->
                        <div style="display:grid; grid-template-columns: 1fr 60px 50px 70px 20px; gap:5px; font-size:0.7rem; color:var(--text-muted); margin-bottom:5px;">
                            <span>Name</span><span>Amt $</span><span>Age</span><span>Type</span><span></span>
                        </div>
                        
                        <div id="eventsList"></div>
                        <div style="font-size:0.75rem; color:#64748b; margin-top:5px;">Events auto-update results.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTS COLUMN -->
        <div class="results-col">
            <div class="card">
                <span class="section-label">Simulation Results (500 Scenarios)</span>
                
                <div class="hero-stats">
                    <div class="big-percent" id="res-success" style="color:var(--accent-green)">--%</div>
                    <div class="hero-text" id="narrative-text">
                        Loading analysis...
                    </div>
                </div>

                <div class="chart-box">
                    <canvas id="mainChart"></canvas>
                </div>

                <div style="display:flex; justify-content:space-between; margin-top:15px; font-size:0.85rem; color:var(--text-muted);">
                    <div>Median Wealth @ 95: <span id="res-median" style="color:white; font-weight:bold;">--</span></div>
                    <div style="cursor:pointer; text-decoration:underline;" onclick="exportConfig()">Save / Share Plan</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const DEATH_AGE = 95;
    const SIMS = 500;

    // --- STATE ---
    let els = {};
    let lifeEvents = []; 
    let isUpdating = false;

    // --- IDS ---
    const simpleIds = ['simpleTotalSavings', 'simpleMonthlySave'];
    const advIds = ['balTaxable', 'balDeferred', 'balRoth', 'conTaxable', 'conDeferred', 'conRoth'];
    const commonIds = ['age', 'retAge', 'spend', 'alloc', 'flexRule', 'ssAge', 'ssAmt'];

    window.onload = () => {
        // Cache Elements
        [...simpleIds, ...advIds, ...commonIds].forEach(id => els[id] = document.getElementById(id));
        
        // Listeners
        commonIds.forEach(id => els[id].addEventListener('input', () => { updateUI(); runSim(); }));
        
        els.simpleTotalSavings.addEventListener('change', () => distributeSavings());
        els.simpleMonthlySave.addEventListener('change', () => distributeContrib());
        advIds.forEach(id => els[id].addEventListener('change', () => sumUpAdvanced()));

        // Add default event
        // lifeEvents.push({ id: Date.now(), name: 'Home Purchase', type: 'expense', cost: 50000, age: 40 });
        // renderEvents();

        runSim();
        updateUI();
    };

    // --- UI LOGIC ---
    function toggleAdvanced() {
        document.getElementById('advPanel').classList.toggle('open');
        const btn = document.querySelector('.adv-toggle-btn');
        btn.innerText = document.getElementById('advPanel').classList.contains('open') ? "Hide Advanced" : "⚙️ Advanced Settings";
    }

    function updateUI() {
        document.getElementById('lbl-age').innerText = els.age.value;
        document.getElementById('lbl-ret').innerText = els.retAge.value;
        document.getElementById('lbl-alloc').innerText = els.alloc.value + "%";
    }

    // --- SMART SYNC LOGIC ---
    function pVal(id) { return parseFloat(els[id].value.replace(/,/g, '')) || 0; }
    function setVal(id, v) { els[id].value = Math.round(v).toLocaleString(); }

    function distributeSavings() {
        if(isUpdating) return;
        isUpdating = true;
        const total = pVal('simpleTotalSavings');
        setVal('balTaxable', total * 0.15);
        setVal('balDeferred', total * 0.75);
        setVal('balRoth', total * 0.10);
        isUpdating = false;
        runSim();
    }

    function distributeContrib() {
        if(isUpdating) return;
        isUpdating = true;
        const total = pVal('simpleMonthlySave');
        setVal('conDeferred', total * 0.75);
        setVal('conTaxable', total * 0.25);
        setVal('conRoth', 0);
        isUpdating = false;
        runSim();
    }

    function sumUpAdvanced() {
        if(isUpdating) return;
        isUpdating = true;
        const totSav = pVal('balTaxable') + pVal('balDeferred') + pVal('balRoth');
        const totCon = pVal('conTaxable') + pVal('conDeferred') + pVal('conRoth');
        setVal('simpleTotalSavings', totSav);
        setVal('simpleMonthlySave', totCon);
        isUpdating = false;
        runSim();
    }

    // --- EVENTS UI (FIXED) ---
    // No prompts. Direct rendering of inputs.
    function addEventUI() {
        const id = Date.now();
        // Add a default event
        lifeEvents.push({ id, name: 'New Event', type: 'expense', cost: 20000, age: parseInt(els.age.value)+5 });
        renderEvents();
        runSim();
    }

    function renderEvents() {
        const div = document.getElementById('eventsList');
        div.innerHTML = '';
        lifeEvents.forEach(ev => {
            const el = document.createElement('div');
            el.className = `event-row ${ev.type}`;
            el.innerHTML = `
                <input type="text" value="${ev.name}" onchange="updateEvent(${ev.id}, 'name', this.value)">
                <input type="text" value="${ev.cost}" onchange="updateEvent(${ev.id}, 'cost', this.value)">
                <input type="number" value="${ev.age}" onchange="updateEvent(${ev.id}, 'age', this.value)">
                <select onchange="updateEvent(${ev.id}, 'type', this.value)">
                    <option value="expense" ${ev.type === 'expense' ? 'selected' : ''}>Exp</option>
                    <option value="income" ${ev.type === 'income' ? 'selected' : ''}>Inc</option>
                </select>
                <span style="cursor:pointer; color:#f87171; text-align:center;" onclick="removeEvent(${ev.id})">×</span>
            `;
            div.appendChild(el);
        });
    }

    window.updateEvent = (id, field, val) => {
        const ev = lifeEvents.find(e => e.id === id);
        if(ev) {
            if(field === 'cost' || field === 'age') ev[field] = parseFloat(val.toString().replace(/,/g,'')) || 0;
            else ev[field] = val;
            runSim();
            // Re-render to update classes if type changed
            if(field === 'type') renderEvents(); 
        }
    }

    window.removeEvent = (id) => { lifeEvents = lifeEvents.filter(e => e.id !== id); renderEvents(); runSim(); };

    // --- SIMULATION ENGINE ---
    function runSim() {
        const curAge = parseInt(els.age.value);
        const retAge = parseInt(els.retAge.value);
        const months = (DEATH_AGE - curAge) * 12;
        const retMonth = (retAge - curAge) * 12;
        const flexRule = els.flexRule.value;
        const ssMonth = (pVal('ssAge') - curAge) * 12;
        
        const infRate = 0.03; 
        const muS = 0.07/12; const sigS = 0.15/Math.sqrt(12);
        const muB = 0.03/12; const sigB = 0.05/Math.sqrt(12);
        const stockAlloc = parseInt(els.alloc.value) / 100;

        let successCount = 0;
        const trajectories = [];

        for (let i = 0; i < SIMS; i++) {
            let bTax = pVal('balTaxable');
            let bDef = pVal('balDeferred');
            let bRoth = pVal('balRoth');
            let failed = false;
            const path = [];
            let prevYearBal = bTax + bDef + bRoth;

            for (let m = 0; m < months; m++) {
                const simAge = curAge + (m/12);

                // 1. Returns
                const u1 = Math.random(); const u2 = Math.random();
                const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                const ret = ((muS + sigS * z) * stockAlloc) + ((muB + sigB * z) * (1-stockAlloc));
                
                bTax *= (1+ret); bDef *= (1+ret); bRoth *= (1+ret);
                
                // 2. Events Check
                let eventExpense = 0;
                let eventIncome = 0;
                lifeEvents.forEach(ev => {
                    if (Math.abs(simAge - ev.age) < 0.1) {
                        const evtMonth = Math.round((ev.age - curAge)*12);
                        if(m === evtMonth) {
                            if (ev.type === 'expense') eventExpense += ev.cost;
                            else eventIncome += ev.cost;
                        }
                    }
                });

                if(eventIncome > 0) bTax += eventIncome;

                // 3. Flows
                if (m < retMonth) {
                    bTax += pVal('conTaxable'); bDef += pVal('conDeferred'); bRoth += pVal('conRoth');
                    
                    if(eventExpense > 0) {
                        if(bTax >= eventExpense) bTax -= eventExpense;
                        else {
                            eventExpense -= bTax; bTax = 0;
                            if(bRoth >= eventExpense) bRoth -= eventExpense;
                            else { bRoth = 0; bTax -= eventExpense; }
                        }
                    }
                } else {
                    const total = bTax + bDef + bRoth;
                    const yrsInRet = (m - retMonth) / 12;
                    let need = pVal('spend') * Math.pow(1+infRate, yrsInRet + (retAge - curAge));

                    if (m % 12 === 0 && flexRule !== 'none') {
                        if (total < prevYearBal * 0.95) need *= (flexRule === 'flexible_20' ? 0.8 : 0.9);
                    }
                    if (m % 12 === 0) prevYearBal = total;

                    if (m >= ssMonth) need -= pVal('ssAmt');
                    need += eventExpense;

                    let rmd = 0;
                    if(simAge > 73 && bDef > 0) rmd = bDef / 25 / 12;

                    let taken = 0;
                    if(rmd > 0) { taken = Math.min(rmd, bDef); bDef -= taken; }
                    need -= taken;

                    if(need > 0) {
                        if(bTax >= need) { bTax -= need; need = 0; } else { need -= bTax; bTax = 0; }
                    }
                    if(need > 0) {
                        const gross = need / 0.78;
                        if(bDef >= gross) { bDef -= gross; need = 0; } else { bDef = 0; need -= (bDef * 0.78); }
                    }
                    if(need > 0) {
                        if(bRoth >= need) { bRoth -= need; need = 0; } else { bRoth = 0; }
                    }
                }

                const nw = bTax + bDef + bRoth;
                if(nw <= 0 && m >= retMonth) failed = true;
                path.push(nw);
            }
            if(!failed) successCount++;
            trajectories.push(path);
        }

        draw(trajectories, months, retMonth);
        updateResults(successCount, SIMS, trajectories);
    }

    // --- VISUALS ---
    function updateResults(s, t, p) {
        const rate = Math.round((s/t)*100);
        const el = document.getElementById('res-success');
        el.innerText = rate + "%";
        el.style.color = rate > 85 ? '#4ade80' : (rate > 60 ? '#facc15' : '#f87171');
        
        const ends = p.map(path=>path[path.length-1]).sort((a,b)=>a-b);
        const med = ends[Math.floor(t/2)];
        document.getElementById('res-median').innerText = "$" + (med/1000000).toFixed(2) + "M";

        let text = "";
        if(rate >= 90) text = "<strong>You are on track.</strong> Your plan is extremely robust. Even in poor markets, you have a safety margin.";
        else if(rate >= 75) text = "<strong>Looking good.</strong> You have a high chance of success. Inflation or a major crash are your only real risks.";
        else if(rate >= 50) text = "<strong>Caution needed.</strong> You succeed in the 'average' case, but fail in difficult markets. Consider saving more or delaying retirement.";
        else text = "<strong>Action required.</strong> Your current plan runs out of money prematurely. Please adjust your savings or retirement age.";
        
        document.getElementById('narrative-text').innerHTML = text;
    }

    function draw(paths, totalM, retM) {
        const cvs = document.getElementById('mainChart');
        const ctx = cvs.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const rect = cvs.parentElement.getBoundingClientRect();
        cvs.width = rect.width * dpr; cvs.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        const w = rect.width; const h = rect.height;

        ctx.fillStyle = '#1e293b'; ctx.fillRect(0,0,w,h);

        const p10=[], p50=[], p90=[];
        for(let m=0; m<totalM; m+=6) {
            const vals = paths.map(p=>p[m]).sort((a,b)=>a-b);
            p10.push(vals[Math.floor(SIMS*0.1)]);
            p50.push(vals[Math.floor(SIMS*0.5)]);
            p90.push(vals[Math.floor(SIMS*0.9)]);
        }

        let max = Math.max(...p90);
        const start = pVal('simpleTotalSavings');
        if(max > start * 40) max = start * 40; 
        
        const xS = w / (p10.length-1);
        const yS = h / max;

        ctx.fillStyle = 'rgba(56, 189, 248, 0.1)';
        ctx.beginPath();
        ctx.moveTo(0, h - p90[0]*yS);
        p90.forEach((v,i) => ctx.lineTo(i*xS, h-v*yS));
        for(let i=p10.length-1; i>=0; i--) ctx.lineTo(i*xS, h-p10[i]*yS);
        ctx.fill();

        ctx.strokeStyle = '#38bdf8'; ctx.lineWidth = 3; ctx.beginPath();
        p50.forEach((v,i)=> i===0?ctx.moveTo(0, h-v*yS):ctx.lineTo(i*xS, h-v*yS));
        ctx.stroke();
        
        const retX = (retM / totalM) * w;
        ctx.strokeStyle = '#facc15'; ctx.setLineDash([5,5]); ctx.beginPath();
        ctx.moveTo(retX, 0); ctx.lineTo(retX, h); ctx.stroke();
    }

    window.exportConfig = () => {
        const d = { inputs: {}, events: lifeEvents };
        [...simpleIds, ...advIds, ...commonIds].forEach(id => d.inputs[id] = els[id].value);
        navigator.clipboard.writeText(btoa(JSON.stringify(d))).then(()=>alert("Plan Copied!"));
    }
</script>
</body>
</html>


