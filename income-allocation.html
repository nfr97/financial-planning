<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'"
    />
    <title>Budget Planner - I Will Teach You to Be Rich</title>
    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
      integrity="sha384-6eeJb4gOKqaZxKTaVh4k0VR9RnpBPLmqvxmSRoXHgNQNz3bMNqPYLNq/MDpwzi0B"
      crossorigin="anonymous"
    ></script>
    <script src="shared.js?v=20260204"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px 30px;
        text-align: center;
      }

      header h1 {
        font-size: 1.8em;
        margin-bottom: 6px;
      }

      header p {
        font-size: 1em;
        opacity: 0.95;
      }

      .content {
        padding: 24px 30px;
      }

      /* Step sections */
      .step-section {
        margin-bottom: 24px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
      }

      .step-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .step-number {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.95em;
        flex-shrink: 0;
      }

      .step-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #1e293b;
      }

      /* Income input */
      .income-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .input-group label {
        font-weight: 500;
        color: #475569;
        font-size: 0.9em;
      }

      .input-group input,
      .input-group select {
        padding: 12px 14px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1em;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
      }

      .tax-estimate-box {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #fbbf24;
        border-radius: 8px;
        padding: 14px 16px;
        margin-top: 12px;
      }

      .tax-estimate-box .estimate-title {
        font-weight: 600;
        color: #92400e;
        margin-bottom: 8px;
      }

      .tax-estimate-box .estimate-details {
        font-size: 0.9em;
        color: #78350f;
        line-height: 1.5;
      }

      .tax-estimate-box .take-home {
        font-size: 1.1em;
        font-weight: 700;
        color: #059669;
        margin-top: 8px;
      }

      /* Philosophy section */
      .philosophy-box {
        background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
        border-left: 4px solid #667eea;
        padding: 16px 20px;
        border-radius: 0 8px 8px 0;
      }

      .philosophy-box h3 {
        color: #4338ca;
        font-size: 1em;
        margin-bottom: 8px;
      }

      .philosophy-box p {
        color: #475569;
        font-size: 0.95em;
        line-height: 1.6;
        margin-bottom: 8px;
      }

      .philosophy-box ul {
        margin: 10px 0 0 20px;
        color: #475569;
        font-size: 0.9em;
        line-height: 1.6;
      }

      /* Preset buttons */
      .preset-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 16px;
      }

      .preset-btn {
        padding: 14px 12px;
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }

      .preset-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .preset-btn.active {
        background: #667eea;
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .preset-btn .preset-name {
        font-weight: 600;
        font-size: 0.95em;
        display: block;
        margin-bottom: 4px;
      }

      .preset-btn .preset-desc {
        font-size: 0.75em;
        opacity: 0.8;
      }

      /* Categories section - compact */
      .categories-grid {
        display: grid;
        gap: 12px;
      }

      .category-card {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
        align-items: center;
        padding: 14px 16px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .category-card.fixed-costs {
        border-left-color: #ef4444;
      }
      .category-card.short-term {
        border-left-color: #f59e0b;
      }
      .category-card.long-term {
        border-left-color: #10b981;
      }
      .category-card.guilt-free {
        border-left-color: #8b5cf6;
      }

      .category-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .category-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .category-name {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.95em;
      }

      .category-percentage {
        font-weight: 700;
        color: #667eea;
        font-size: 1.1em;
        min-width: 45px;
        text-align: right;
      }

      .category-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
      }

      .category-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .category-slider::-webkit-slider-thumb:hover {
        transform: scale(1.15);
      }

      .category-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        border: none;
      }

      .category-amounts {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
        min-width: 100px;
      }

      .amount-monthly {
        font-weight: 700;
        color: #1e293b;
        font-size: 1.05em;
      }

      .amount-annual {
        font-size: 0.8em;
        color: #64748b;
      }

      .category-hint {
        font-size: 0.8em;
        color: #64748b;
        font-style: italic;
      }

      /* Chart section */
      .chart-section {
        margin-top: 24px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
      }

      .chart-section h3 {
        font-size: 1.1em;
        color: #1e293b;
        margin-bottom: 16px;
        text-align: center;
      }

      .chart-container {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        align-items: center;
        justify-content: center;
      }

      .chart-wrapper {
        width: 200px;
        height: 200px;
      }

      .chart-legend {
        flex: 1;
        min-width: 200px;
        max-width: 300px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
      }

      .legend-item:last-child {
        border-bottom: none;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        flex-shrink: 0;
      }

      .legend-label {
        flex: 1;
        font-size: 0.9em;
        color: #475569;
      }

      .legend-value {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.9em;
      }

      .legend-pct {
        color: #667eea;
        font-weight: 600;
        font-size: 0.85em;
        min-width: 35px;
        text-align: right;
      }

      .download-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin: 16px auto 0;
        padding: 10px 20px;
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .download-btn:hover {
        background: #667eea;
        color: white;
      }

      .save-session-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin: 16px 0 0;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.2s;
      }

      .save-session-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .save-session-btn.saved {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      /* Footer */
      footer {
        background: #f8fafc;
        padding: 20px 30px;
        border-top: 1px solid #e2e8f0;
        text-align: center;
        color: #64748b;
        font-size: 0.9em;
      }

      footer a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
      }

      footer a:hover {
        text-decoration: underline;
      }

      .workflow-nav {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #e2e8f0;
      }

      .workflow-nav a {
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
      }

      .workflow-nav .nav-arrow {
        background: #667eea;
        color: white;
      }

      .workflow-nav .nav-arrow:hover {
        background: #5568d3;
        text-decoration: none;
      }

      /* Navigation Tabs */
      .nav-tabs {
        max-width: 900px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding: 0 20px;
      }

      .nav-tab {
        padding: 12px 16px;
        text-align: center;
        text-decoration: none;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
        font-size: 0.9em;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .nav-tab:hover {
        color: white;
      }

      .nav-tab.active {
        color: white;
        border-bottom-color: white;
        font-weight: 600;
      }

      /* Accessibility */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #667eea;
        color: white;
        padding: 8px 16px;
        z-index: 100;
        text-decoration: none;
        font-weight: 600;
      }

      .skip-link:focus {
        top: 0;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      *:focus-visible {
        outline: 3px solid #667eea;
        outline-offset: 2px;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .income-row {
          grid-template-columns: 1fr;
        }

        .preset-grid {
          grid-template-columns: 1fr;
        }

        .category-card {
          grid-template-columns: 1fr;
          gap: 8px;
        }

        .category-amounts {
          flex-direction: row;
          justify-content: space-between;
          width: 100%;
        }

        .chart-container {
          flex-direction: column;
        }

        .chart-wrapper {
          width: 100%;
          max-width: 250px;
          height: auto;
          aspect-ratio: 1;
        }

        .chart-legend {
          min-width: 0;
          max-width: none;
          width: 100%;
        }

        .preset-btn .preset-name {
          font-size: 1.1em;
        }

        .preset-btn .preset-desc {
          font-size: 0.85em;
        }
      }
    </style>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <nav class="nav-tabs" role="navigation" aria-label="Main navigation">
      <a href="income-allocation.html" class="nav-tab active" aria-current="page">Budget Planner</a>
      <a href="transaction-analyzer.html" class="nav-tab">Spending Tracker</a>
      <a href="retirement-simulator.html" class="nav-tab">Retirement Forecast</a>
    </nav>

    <div class="container" role="document">
      <header role="banner">
        <h1>
          <a href="index.html" style="color: inherit; text-decoration: none">Budget Planner</a>
        </h1>
        <p>Build your conscious spending plan</p>
      </header>

      <main id="main-content" class="content" role="main">
        <!-- Step 1: Enter Income -->
        <section class="step-section" aria-labelledby="step1-title">
          <div class="step-header">
            <div class="step-number">1</div>
            <h2 class="step-title" id="step1-title">Enter Your Pre-Tax Income</h2>
          </div>

          <div class="income-row">
            <div class="input-group">
              <label for="income">Annual Salary</label>
              <input
                type="text"
                id="income"
                value="75,000"
                placeholder="e.g., 75,000"
                autocomplete="off"
              />
            </div>
            <div class="input-group">
              <label for="zipCode">ZIP Code (for tax estimate)</label>
              <input
                type="text"
                id="zipCode"
                placeholder="e.g., 94102"
                maxlength="5"
                inputmode="numeric"
              />
            </div>
          </div>

          <div class="tax-estimate-box" id="taxEstimateBox">
            <div class="estimate-title">Tax Estimate</div>
            <div class="estimate-details" id="taxDetails">
              Enter your ZIP code above to calculate federal, state, and FICA taxes
            </div>
            <div class="take-home" id="takeHomeAmount"></div>
          </div>
        </section>

        <!-- Step 2: Philosophy & Presets -->
        <section class="step-section" aria-labelledby="step2-title">
          <div class="step-header">
            <div class="step-number">2</div>
            <h2 class="step-title" id="step2-title">Choose Your Approach</h2>
          </div>

          <div class="philosophy-box">
            <h3>The Ramit Sethi Method</h3>
            <p>
              From "I Will Teach You to Be Rich" - the idea is simple: divide your
              <strong>after-tax</strong> income into four buckets so you always know where your
              money goes. Cover essentials first, automate savings, then spend the rest guilt-free.
            </p>
            <ul>
              <li><strong>Fixed Costs</strong> - Rent, utilities, insurance, debt minimums</li>
              <li><strong>Short-Term Savings</strong> - Emergency fund, vacation, big purchases</li>
              <li><strong>Long-Term Savings</strong> - 401(k), IRA, investments for retirement</li>
              <li><strong>Guilt-Free Spending</strong> - Whatever makes you happy!</li>
            </ul>
          </div>

          <div class="preset-grid">
            <button type="button" class="preset-btn" id="preset-balanced">
              <span class="preset-name">Balanced</span>
              <span class="preset-desc">50/20/20/10 - Good for most</span>
            </button>
            <button type="button" class="preset-btn" id="preset-aggressive">
              <span class="preset-name">Aggressive Saver</span>
              <span class="preset-desc">50/15/30/5 - Max retirement</span>
            </button>
            <button type="button" class="preset-btn" id="preset-debt">
              <span class="preset-name">Debt Crusher</span>
              <span class="preset-desc">60/20/15/5 - Pay off fast</span>
            </button>
          </div>
        </section>

        <!-- Step 3: Adjust Allocations -->
        <section class="step-section" aria-labelledby="step3-title">
          <div class="step-header">
            <div class="step-number">3</div>
            <h2 class="step-title" id="step3-title">Adjust Your Allocations</h2>
          </div>

          <div class="categories-grid">
            <!-- Fixed Costs -->
            <div class="category-card fixed-costs">
              <div class="category-info">
                <div class="category-top-row">
                  <span class="category-name">Fixed Costs</span>
                  <span class="category-percentage" id="fixedCostsPct">50%</span>
                </div>
                <input
                  type="range"
                  class="category-slider"
                  id="fixedCostsSlider"
                  min="0"
                  max="100"
                  value="50"
                />
                <span class="category-hint">Rent, bills, insurance, minimums</span>
              </div>
              <div class="category-amounts">
                <span class="amount-monthly" id="fixedCostsMonthly">$0</span>
                <span class="amount-annual" id="fixedCostsAnnual">$0/year</span>
              </div>
            </div>

            <!-- Short-Term Savings -->
            <div class="category-card short-term">
              <div class="category-info">
                <div class="category-top-row">
                  <span class="category-name">Short-Term Savings</span>
                  <span class="category-percentage" id="shortTermPct">20%</span>
                </div>
                <input
                  type="range"
                  class="category-slider"
                  id="shortTermSlider"
                  min="0"
                  max="100"
                  value="20"
                />
                <span class="category-hint">Emergency fund, vacations, goals</span>
              </div>
              <div class="category-amounts">
                <span class="amount-monthly" id="shortTermMonthly">$0</span>
                <span class="amount-annual" id="shortTermAnnual">$0/year</span>
              </div>
            </div>

            <!-- Long-Term Savings -->
            <div class="category-card long-term">
              <div class="category-info">
                <div class="category-top-row">
                  <span class="category-name">Long-Term Savings</span>
                  <span class="category-percentage" id="longTermPct">20%</span>
                </div>
                <input
                  type="range"
                  class="category-slider"
                  id="longTermSlider"
                  min="0"
                  max="100"
                  value="20"
                />
                <span class="category-hint">401(k), IRA, retirement investments</span>
              </div>
              <div class="category-amounts">
                <span class="amount-monthly" id="longTermMonthly">$0</span>
                <span class="amount-annual" id="longTermAnnual">$0/year</span>
              </div>
            </div>

            <!-- Guilt-Free -->
            <div class="category-card guilt-free">
              <div class="category-info">
                <div class="category-top-row">
                  <span class="category-name">Guilt-Free Spending</span>
                  <span class="category-percentage" id="guiltFreePct">10%</span>
                </div>
                <input
                  type="range"
                  class="category-slider"
                  id="guiltFreeSlider"
                  min="0"
                  max="100"
                  value="10"
                />
                <span class="category-hint">Dining, hobbies, fun - no guilt!</span>
              </div>
              <div class="category-amounts">
                <span class="amount-monthly" id="guiltFreeMonthly">$0</span>
                <span class="amount-annual" id="guiltFreeAnnual">$0/year</span>
              </div>
            </div>
          </div>

          <button type="button" class="save-session-btn" id="saveSessionBtn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
              <polyline points="17 21 17 13 7 13 7 21" />
              <polyline points="7 3 7 8 15 8" />
            </svg>
            Save Session
          </button>
        </section>

        <!-- Budget at a Glance -->
        <section class="chart-section" aria-labelledby="chart-title">
          <h3 id="chart-title">Your Budget at a Glance</h3>
          <div class="chart-container">
            <div class="chart-wrapper">
              <canvas id="budgetChart"></canvas>
            </div>
            <div class="chart-legend" id="chartLegend"></div>
          </div>
          <button type="button" class="download-btn" id="downloadChartBtn">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Download as PNG
          </button>
        </section>
      </main>

      <footer role="contentinfo">
        <p style="margin-bottom: 10px; color: #94a3b8; font-size: 0.85em">
          This tool is for educational purposes only. Consult a financial advisor for personalized
          advice.
        </p>
        <p>
          Inspired by
          <a href="https://www.iwillteachyoutoberich.com/" target="_blank" rel="noopener"
            >Ramit Sethi's "I Will Teach You to Be Rich"</a
          >
        </p>
        <nav class="workflow-nav">
          <a href="index.html">Home</a>
          <a href="transaction-analyzer.html" class="nav-arrow">Continue to Spending Tracker</a>
        </nav>
      </footer>
    </div>

    <script>
      class BudgetPlanner {
        constructor() {
          this.categories = {
            fixedCosts: { value: 50, locked: false },
            shortTerm: { value: 20, locked: false },
            longTerm: { value: 20, locked: false },
            guiltFree: { value: 10, locked: false },
          };
          this.categoryOrder = ['fixedCosts', 'shortTerm', 'longTerm', 'guiltFree'];
          this.monthlyNetIncome = 0;
          this.chart = null;

          this.init();
        }

        init() {
          // Get DOM elements
          this.incomeInput = document.getElementById('income');
          this.zipCodeInput = document.getElementById('zipCode');
          this.taxDetailsEl = document.getElementById('taxDetails');
          this.takeHomeEl = document.getElementById('takeHomeAmount');

          // Slider elements
          this.sliders = {
            fixedCosts: document.getElementById('fixedCostsSlider'),
            shortTerm: document.getElementById('shortTermSlider'),
            longTerm: document.getElementById('longTermSlider'),
            guiltFree: document.getElementById('guiltFreeSlider'),
          };

          // Setup event listeners
          this.incomeInput.addEventListener('input', () => this.handleIncomeChange());
          this.incomeInput.addEventListener('blur', () => this.formatIncomeDisplay());
          this.incomeInput.addEventListener('focus', () => this.clearIncomeFormat());
          this.zipCodeInput.addEventListener('input', () => this.calculate());

          // Slider events
          for (const [key, slider] of Object.entries(this.sliders)) {
            slider.addEventListener('input', (e) => {
              this.categories[key].locked = true;
              this.adjustCategories(key, parseInt(e.target.value));
            });
          }

          // Preset buttons
          document.getElementById('preset-balanced').addEventListener('click', () => {
            this.applyPreset({ fixedCosts: 50, shortTerm: 20, longTerm: 20, guiltFree: 10 });
            this.highlightPreset('preset-balanced');
          });
          document.getElementById('preset-aggressive').addEventListener('click', () => {
            this.applyPreset({ fixedCosts: 50, shortTerm: 15, longTerm: 30, guiltFree: 5 });
            this.highlightPreset('preset-aggressive');
          });
          document.getElementById('preset-debt').addEventListener('click', () => {
            this.applyPreset({ fixedCosts: 60, shortTerm: 20, longTerm: 15, guiltFree: 5 });
            this.highlightPreset('preset-debt');
          });

          // Download button
          document.getElementById('downloadChartBtn').addEventListener('click', () => {
            this.downloadChart();
          });

          // Save session button
          document.getElementById('saveSessionBtn').addEventListener('click', () => {
            this.saveData();
            const btn = document.getElementById('saveSessionBtn');
            btn.classList.add('saved');
            btn.innerHTML = `
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Saved! Available to other tools
            `;
            setTimeout(() => {
              btn.classList.remove('saved');
              btn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save Session
              `;
            }, 2000);
          });

          // Load saved data or use defaults
          this.loadSavedData();

          // Initial calculation
          this.formatIncomeDisplay();
          this.calculate();
        }

        loadSavedData() {
          const saved = StorageUtils.get('budgetPlannerData');
          if (saved) {
            if (saved.monthlyIncome) {
              // Convert monthly back to annual for display
              this.incomeInput.value = (saved.monthlyIncome * 12).toLocaleString();
            }
            if (saved.fixedCosts !== undefined) this.categories.fixedCosts.value = saved.fixedCosts;
            if (saved.shortTerm !== undefined) this.categories.shortTerm.value = saved.shortTerm;
            if (saved.longTerm !== undefined) this.categories.longTerm.value = saved.longTerm;
            if (saved.guiltFree !== undefined) this.categories.guiltFree.value = saved.guiltFree;
            if (saved.zipCode) this.zipCodeInput.value = saved.zipCode;

            // Update sliders
            for (const [key, cat] of Object.entries(this.categories)) {
              this.sliders[key].value = cat.value;
            }
          }
        }

        handleIncomeChange() {
          this.calculate();
        }

        clearIncomeFormat() {
          const value = this.parseNumber(this.incomeInput.value);
          if (value > 0) {
            this.incomeInput.value = value;
          }
        }

        formatIncomeDisplay() {
          const value = this.parseNumber(this.incomeInput.value);
          if (value > 0) {
            this.incomeInput.value = value.toLocaleString();
          }
        }

        parseNumber(str) {
          return parseFloat(String(str).replace(/[^0-9.]/g, '')) || 0;
        }

        getAnnualGrossIncome() {
          return this.parseNumber(this.incomeInput.value);
        }

        estimateTaxes(annualIncome, zipCode) {
          if (!annualIncome || annualIncome <= 0) {
            return { federal: 0, state: 0, fica: 0, total: 0 };
          }

          // Federal tax (2024 single filer, simplified)
          const standardDeduction = 14600;
          const taxable = Math.max(0, annualIncome - standardDeduction);

          let federal = 0;
          if (taxable <= 11600) {
            federal = taxable * 0.1;
          } else if (taxable <= 47150) {
            federal = 1160 + (taxable - 11600) * 0.12;
          } else if (taxable <= 100525) {
            federal = 5426 + (taxable - 47150) * 0.22;
          } else if (taxable <= 191950) {
            federal = 17168.5 + (taxable - 100525) * 0.24;
          } else if (taxable <= 243725) {
            federal = 39110.5 + (taxable - 191950) * 0.32;
          } else if (taxable <= 609350) {
            federal = 55678.5 + (taxable - 243725) * 0.35;
          } else {
            federal = 183647.25 + (taxable - 609350) * 0.37;
          }

          // FICA
          const ssWageBase = 168600;
          const ssTax = Math.min(annualIncome, ssWageBase) * 0.062;
          const medicareTax = annualIncome * 0.0145;
          const addlMedicare = annualIncome > 200000 ? (annualIncome - 200000) * 0.009 : 0;
          const fica = ssTax + medicareTax + addlMedicare;

          // State tax by ZIP
          const stateRate = this.getStateTaxRate(zipCode);
          const state = annualIncome * stateRate;

          return { federal, state, fica, total: federal + state + fica };
        }

        getStateTaxRate(zipCode) {
          if (!zipCode || zipCode.length !== 5) return 0.05;
          const zip = parseInt(zipCode);

          // No state income tax
          if (zip >= 99500 && zip <= 99950) return 0; // Alaska
          if (zip >= 32000 && zip <= 34999) return 0; // Florida
          if (zip >= 89000 && zip <= 89899) return 0; // Nevada
          if (zip >= 3000 && zip <= 3899) return 0; // New Hampshire
          if (zip >= 57000 && zip <= 57799) return 0; // South Dakota
          if (zip >= 37000 && zip <= 38599) return 0; // Tennessee
          if (zip >= 75000 && zip <= 79999) return 0; // Texas
          if (zip >= 88500 && zip <= 88599) return 0; // Texas
          if (zip >= 98000 && zip <= 99499) return 0; // Washington
          if (zip >= 82000 && zip <= 83199) return 0; // Wyoming

          // States with income tax
          if (zip >= 90000 && zip <= 96199) return 0.093; // California
          if (zip >= 10000 && zip <= 14999) return 0.0685; // New York
          if (zip >= 97000 && zip <= 97999) return 0.099; // Oregon
          if (zip >= 55000 && zip <= 56799) return 0.0985; // Minnesota
          if (zip >= 96700 && zip <= 96899) return 0.11; // Hawaii
          if (zip >= 20000 && zip <= 20599) return 0.0895; // DC

          return 0.05; // Default 5%
        }

        calculate() {
          const annualGross = this.getAnnualGrossIncome();
          const zipCode = this.zipCodeInput.value;
          const taxes = this.estimateTaxes(annualGross, zipCode);

          const annualNet = annualGross - taxes.total;
          this.monthlyNetIncome = annualNet / 12;

          // Update tax display
          if (zipCode && zipCode.length === 5 && annualGross > 0) {
            const effectiveRate = ((taxes.total / annualGross) * 100).toFixed(1);
            this.taxDetailsEl.innerHTML = `
              Federal: ${this.formatCurrency(taxes.federal)} |
              State: ${this.formatCurrency(taxes.state)} |
              FICA: ${this.formatCurrency(taxes.fica)}<br>
              <span style="font-size: 0.85em; opacity: 0.8;">Effective rate: ${effectiveRate}% (single filer, standard deduction)</span>
            `;
            this.takeHomeEl.textContent = `Take-home: ${this.formatCurrency(annualNet)}/year (${this.formatCurrency(this.monthlyNetIncome)}/month)`;
          } else if (annualGross > 0) {
            this.taxDetailsEl.textContent =
              'Enter your ZIP code to calculate federal, state, and FICA taxes';
            this.takeHomeEl.textContent = '';
          } else {
            this.taxDetailsEl.textContent =
              'Enter your income and ZIP code to see your tax estimate';
            this.takeHomeEl.textContent = '';
          }

          // Update category amounts
          this.updateCategoryDisplays();

          // Update chart
          this.updateChart();

          // Save data
          this.saveData();
        }

        updateCategoryDisplays() {
          const monthly = this.monthlyNetIncome;

          for (const key of this.categoryOrder) {
            const pct = this.categories[key].value;
            const monthlyAmt = (monthly * pct) / 100;
            const annualAmt = monthlyAmt * 12;

            document.getElementById(`${key}Pct`).textContent = `${Math.round(pct)}%`;
            document.getElementById(`${key}Monthly`).textContent = this.formatCurrency(monthlyAmt);
            document.getElementById(`${key}Annual`).textContent =
              `${this.formatCurrency(annualAmt)}/year`;

            // Update slider position
            this.sliders[key].value = Math.round(pct);
          }
        }

        adjustCategories(changedKey, newValue) {
          const oldValue = this.categories[changedKey].value;
          const diff = newValue - oldValue;

          if (diff === 0) return;

          // Clear preset highlight
          document.querySelectorAll('.preset-btn').forEach((btn) => btn.classList.remove('active'));

          this.categories[changedKey].value = newValue;

          // Get categories below the changed one
          const changedIndex = this.categoryOrder.indexOf(changedKey);
          const below = this.categoryOrder.slice(changedIndex + 1);

          if (below.length === 0) {
            this.calculate();
            return;
          }

          // Calculate total above including changed
          let totalAbove = 0;
          for (let i = 0; i <= changedIndex; i++) {
            totalAbove += this.categories[this.categoryOrder[i]].value;
          }

          const targetBelow = 100 - totalAbove;

          // Get current total below
          let totalBelow = 0;
          for (const k of below) {
            totalBelow += this.categories[k].value;
          }

          // Redistribute proportionally
          if (totalBelow > 0) {
            let remaining = targetBelow;
            for (let i = 0; i < below.length; i++) {
              const k = below[i];
              if (i === below.length - 1) {
                this.categories[k].value = Math.max(0, Math.min(100, remaining));
              } else {
                const proportion = this.categories[k].value / totalBelow;
                const newVal = Math.round(targetBelow * proportion);
                this.categories[k].value = Math.max(0, Math.min(100, newVal));
                remaining -= this.categories[k].value;
              }
            }
          } else {
            // Distribute evenly
            const split = Math.floor(targetBelow / below.length);
            let rem = targetBelow % below.length;
            for (const k of below) {
              this.categories[k].value = split + (rem > 0 ? 1 : 0);
              if (rem > 0) rem--;
            }
          }

          this.calculate();
        }

        applyPreset(values) {
          // Reset all locked states
          for (const key of this.categoryOrder) {
            this.categories[key].locked = false;
            this.categories[key].value = values[key];
          }
          this.calculate();
        }

        highlightPreset(id) {
          document.querySelectorAll('.preset-btn').forEach((btn) => btn.classList.remove('active'));
          document.getElementById(id).classList.add('active');
        }

        updateChart() {
          const ctx = document.getElementById('budgetChart');
          if (!ctx) return;

          const data = this.categoryOrder.map((key) => this.categories[key].value);
          const colors = ['#ef4444', '#f59e0b', '#10b981', '#8b5cf6'];
          const labels = ['Fixed Costs', 'Short-Term', 'Long-Term', 'Guilt-Free'];

          if (this.chart) {
            this.chart.data.datasets[0].data = data;
            this.chart.update();
          } else {
            this.chart = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: labels,
                datasets: [
                  {
                    data: data,
                    backgroundColor: colors,
                    borderColor: '#ffffff',
                    borderWidth: 3,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  legend: { display: false },
                  tooltip: {
                    callbacks: {
                      label: (ctx) => {
                        const pct = ctx.raw;
                        const amt = (this.monthlyNetIncome * pct) / 100;
                        return `${ctx.label}: ${pct}% (${this.formatCurrency(amt)}/mo)`;
                      },
                    },
                  },
                },
                cutout: '55%',
              },
            });
          }

          // Update legend
          const legendEl = document.getElementById('chartLegend');
          legendEl.innerHTML = this.categoryOrder
            .map((key, i) => {
              const pct = this.categories[key].value;
              const amt = (this.monthlyNetIncome * pct) / 100;
              return `
              <div class="legend-item">
                <div class="legend-color" style="background: ${colors[i]}"></div>
                <span class="legend-label">${labels[i]}</span>
                <span class="legend-value">${this.formatCurrency(amt)}/mo</span>
                <span class="legend-pct">${Math.round(pct)}%</span>
              </div>
            `;
            })
            .join('');
        }

        downloadChart() {
          const canvas = document.getElementById('budgetChart');
          if (!canvas || !this.chart) return;

          // Create a temporary canvas with white background
          const tempCanvas = document.createElement('canvas');
          const size = 400;
          tempCanvas.width = size;
          tempCanvas.height = size;
          const tempCtx = tempCanvas.getContext('2d');

          // White background
          tempCtx.fillStyle = '#ffffff';
          tempCtx.fillRect(0, 0, size, size);

          // Draw the chart
          tempCtx.drawImage(canvas, 0, 0, size, size);

          // Download
          const link = document.createElement('a');
          link.download = 'budget-allocation.png';
          link.href = tempCanvas.toDataURL('image/png');
          link.click();
        }

        saveData() {
          const data = {
            monthlyIncome: this.monthlyNetIncome,
            fixedCosts: this.categories.fixedCosts.value,
            shortTerm: this.categories.shortTerm.value,
            longTerm: this.categories.longTerm.value,
            guiltFree: this.categories.guiltFree.value,
            zipCode: this.zipCodeInput.value,
            lastUpdated: new Date().toISOString(),
          };
          StorageUtils.set('budgetPlannerData', data);

          // Also save retirement-specific data
          const monthlyRetirement = (this.monthlyNetIncome * this.categories.longTerm.value) / 100;
          StorageUtils.set('budgetRetirementData', {
            annualContribution: monthlyRetirement * 12,
            lastUpdated: new Date().toISOString(),
          });
        }

        formatCurrency(value) {
          if (typeof FinanceUtils !== 'undefined' && FinanceUtils.formatCurrency) {
            return FinanceUtils.formatCurrency(value);
          }
          return '$' + Math.round(value).toLocaleString();
        }
      }

      // Initialize when DOM is ready
      if (typeof DOMUtils !== 'undefined' && DOMUtils.ready) {
        DOMUtils.ready(() => {
          window.budgetPlanner = new BudgetPlanner();

          // Initialize session toolbar if available
          if (typeof SessionManager !== 'undefined' && SessionManager.initToolbar) {
            SessionManager.initToolbar(
              () => ({
                budgetPlanner: StorageUtils.get('budgetPlannerData'),
              }),
              () => window.location.reload()
            );
          }
        });
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          window.budgetPlanner = new BudgetPlanner();
        });
      }
    </script>
  </body>
</html>
