<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'"
    />
    <meta
      name="description"
      content="Monte Carlo retirement planning simulator with life events modeling. Calculate your retirement success rate using probabilistic simulations."
    />
    <title>Monte Carlo Retirement Projection Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="shared.js?v=20251229"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      header h1 {
        font-size: 2.2em;
        margin-bottom: 10px;
        line-height: 1.2;
      }

      header p {
        font-size: 1.2em;
        opacity: 0.95;
      }

      .content {
        padding: 30px;
      }

      /* Development Warning Banner */
      .dev-warning {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-bottom: 3px solid #d97706;
        padding: 16px 20px;
        text-align: center;
        color: #92400e;
        font-weight: 600;
        font-size: 0.95em;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        position: relative;
        z-index: 1000;
      }

      .dev-warning-icon {
        font-size: 1.3em;
        margin-right: 8px;
        vertical-align: middle;
      }

      .dev-warning-text {
        display: inline-block;
        vertical-align: middle;
      }

      .dev-warning a {
        color: #78350f;
        text-decoration: underline;
        font-weight: 700;
      }

      .dev-warning a:hover {
        color: #451a03;
      }

      .input-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .input-group {
        display: flex;
        flex-direction: column;
      }

      .input-group label {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
        font-size: 1.05em;
      }

      .input-group input {
        padding: 14px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 1.1em;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .input-group small {
        margin-top: 6px;
        color: #666;
        font-size: 0.9em;
        line-height: 1.4;
      }

      .button-container {
        text-align: center;
        margin: 30px 0;
      }

      #runSimulation {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.1em;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      #runSimulation:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      #runSimulation:active {
        transform: translateY(0);
      }

      #runSimulation:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      #runSimulation.running {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        cursor: wait;
      }

      #runSimulation.running::before {
        content: '';
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        margin-right: 10px;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .progress {
        text-align: center;
        margin: 20px 0;
        font-size: 1em;
        color: #667eea;
        font-weight: 600;
        min-height: 24px;
      }

      .results {
        display: none;
        margin-top: 30px;
      }

      .results.show {
        display: block;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .stat-card.success {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      }

      .stat-card h3 {
        font-size: 1em;
        color: #444;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 700;
      }

      .stat-card .value {
        font-size: 2.4em;
        font-weight: 800;
        color: #222;
        line-height: 1.1;
      }

      .stat-card.success .value {
        color: #00796b;
      }

      .stat-card .description {
        font-size: 0.9em;
        color: #555;
        margin-top: 10px;
        line-height: 1.5;
      }

      /* Navigation Tabs */
      .nav-tabs {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        background: transparent;
        gap: 8px;
        padding: 0 20px;
      }

      .nav-tab {
        padding: 14px 16px;
        text-align: center;
        text-decoration: none;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
        font-size: 0.95em;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        background: transparent;
      }

      .nav-tab:hover {
        color: rgba(255, 255, 255, 0.95);
      }

      .nav-tab.active {
        color: white;
        border-bottom-color: white;
        font-weight: 600;
      }

      /* 508 Compliance - Focus indicators */
      button:focus,
      input:focus,
      select:focus {
        outline: 3px solid #667eea;
        outline-offset: 2px;
      }

      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #667eea;
        color: white;
        padding: 8px;
        text-decoration: none;
        z-index: 100;
      }

      .skip-link:focus {
        top: 0;
      }

      /* Screen reader only content */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      .chart-container {
        margin: 30px 0;
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .chart-container h3 {
        margin-bottom: 20px;
        color: #333;
        font-size: 1.3em;
        font-weight: 700;
      }

      .chart-wrapper {
        position: relative;
        height: 450px;
      }

      .chart-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
        gap: 10px;
      }

      .download-chart-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: white;
        border: 1px solid #667eea;
        color: #667eea;
        border-radius: 6px;
        font-size: 0.85em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .download-chart-btn:hover {
        background: #667eea;
        color: white;
      }

      .download-chart-btn:focus {
        outline: 2px solid #667eea;
        outline-offset: 2px;
      }

      footer {
        background: #f5f5f5;
        padding: 24px 30px;
        border-top: 1px solid #e0e0e0;
        text-align: center;
        color: #555;
        font-size: 1em;
        line-height: 1.6;
      }

      footer strong {
        color: #333;
      }

      footer .disclaimer {
        font-size: 0.85em;
        color: #888;
        margin-bottom: 12px;
      }

      .workflow-nav {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 30px;
        padding: 20px 0;
        margin-top: 15px;
        border-top: 1px solid #e0e0e0;
      }

      .workflow-nav a {
        text-decoration: none;
        font-weight: 600;
        padding: 10px 20px;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .workflow-nav .nav-arrow {
        background: #667eea;
        color: white;
      }

      .workflow-nav .nav-arrow:hover {
        background: #5568d3;
        text-decoration: none;
      }

      .workflow-nav .home-link {
        color: #667eea;
        font-size: 0.95em;
      }

      .workflow-nav .home-link:hover {
        background: #f0f4ff;
        text-decoration: none;
      }

      .version-text {
        margin-top: 16px;
        font-size: 0.75em;
        color: #9ca3af;
      }

      /* Life Events Section */
      .life-events-section {
        margin: 30px 0;
        border: 2px dashed #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
      }

      .toggle-events-btn {
        width: 100%;
        background: #f9f9f9;
        border: none;
        padding: 15px 20px;
        font-size: 1em;
        font-weight: 600;
        color: #555;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background 0.3s;
      }

      .toggle-events-btn:hover {
        background: #f0f0f0;
      }

      .toggle-events-btn .arrow {
        transition: transform 0.3s;
        font-size: 0.8em;
      }

      .toggle-events-btn.active .arrow {
        transform: rotate(180deg);
      }

      .events-panel {
        display: none;
        padding: 20px;
        background: #fafafa;
      }

      .events-panel.show {
        display: block;
      }

      .events-description {
        color: #666;
        margin-bottom: 20px;
        font-size: 0.95em;
        line-height: 1.5;
      }

      .events-controls {
        margin-bottom: 20px;
      }

      .event-presets {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }

      .event-preset-btn {
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        padding: 6px 14px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.85em;
        font-weight: 500;
        transition: all 0.2s;
      }

      .event-preset-btn:hover {
        background: #667eea;
        color: white;
      }

      .add-event-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
      }

      .add-event-btn:hover {
        background: #5568d3;
      }

      .events-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .event-item {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto;
        gap: 15px;
        align-items: end;
      }

      .event-field {
        display: flex;
        flex-direction: column;
      }

      .event-field label {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .event-field input,
      .event-field select {
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.95em;
      }

      .event-field input:focus,
      .event-field select:focus {
        outline: none;
        border-color: #667eea;
      }

      .delete-event-btn {
        background: #f87171;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.2em;
        transition: background 0.3s;
        height: 36px;
      }

      .delete-event-btn:hover {
        background: #dc2626;
      }

      .events-empty {
        text-align: center;
        padding: 30px;
        color: #999;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .event-item {
          grid-template-columns: 1fr;
          gap: 12px;
          padding: 12px;
        }

        .delete-event-btn {
          width: 100%;
          height: 40px;
          margin-top: 8px;
        }

        .life-events-section {
          margin: 20px 0;
        }

        .events-panel {
          padding: 15px;
        }
      }

      @media (max-width: 768px) {
        .nav-tabs {
          padding: 0 10px;
          gap: 4px;
        }

        .nav-tab {
          padding: 12px 8px;
          font-size: 0.85em;
        }

        header h1 {
          font-size: 1.6em;
        }

        header p {
          font-size: 1.05em;
        }

        .content {
          padding: 20px;
        }

        .input-section {
          grid-template-columns: 1fr;
        }

        .input-group label {
          font-size: 1em;
        }

        .input-group input {
          font-size: 1.05em;
        }

        .stat-card .value {
          font-size: 2em;
        }

        .stat-card h3 {
          font-size: 0.9em;
        }

        .stat-card .description {
          font-size: 0.85em;
        }

        .chart-wrapper {
          height: 350px;
        }

        .chart-container h3 {
          font-size: 1.1em;
        }

        .chart-actions {
          justify-content: center;
        }

        .download-chart-btn {
          font-size: 0.8em;
          padding: 8px 12px;
        }

        footer {
          font-size: 0.95em;
          padding: 20px;
        }
      }

      /* Mode Toggle */
      .mode-toggle-section {
        margin-bottom: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        border-radius: 10px;
        border: 1px solid #e0e0e0;
      }

      .mode-toggle-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
      }

      .mode-toggle-info h3 {
        margin: 0 0 5px 0;
        font-size: 1.1em;
        color: #333;
      }

      .mode-toggle-info p {
        margin: 0;
        font-size: 0.9em;
        color: #666;
      }

      .mode-toggle {
        display: flex;
        background: #fff;
        border-radius: 8px;
        padding: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .mode-btn {
        padding: 10px 20px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 500;
        color: #666;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .mode-btn:hover {
        color: #333;
      }

      .mode-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      /* Collapsible sections */
      .section-wrapper {
        margin-bottom: 25px;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px 20px;
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        transition: background 0.2s;
      }

      .section-header:hover {
        background: #f0f0f0;
      }

      .section-header h3 {
        margin: 0;
        font-size: 1.05em;
        color: #333;
        flex: 1;
      }

      .section-header .section-icon {
        font-size: 1.2em;
      }

      .section-header .toggle-arrow {
        font-size: 0.8em;
        color: #666;
        transition: transform 0.3s;
      }

      .section-header.expanded .toggle-arrow {
        transform: rotate(180deg);
      }

      .section-content {
        display: none;
        padding: 20px;
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-top: none;
        border-radius: 0 0 8px 8px;
      }

      .section-content.show {
        display: block;
      }

      /* Account breakdown */
      .account-group {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e8e8e8;
      }

      .account-group-title {
        font-weight: 600;
        color: #555;
        font-size: 0.95em;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
      }

      .account-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 10px;
      }

      .account-row:last-child {
        margin-bottom: 0;
      }

      /* Social Security section */
      .ss-option-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      .ss-option-btn {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95em;
        color: #555;
        transition: all 0.2s;
        text-align: center;
      }

      .ss-option-btn:hover {
        border-color: #667eea;
        color: #667eea;
      }

      .ss-option-btn.active {
        border-color: #667eea;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1) 0%,
          rgba(118, 75, 162, 0.1) 100%
        );
        color: #667eea;
        font-weight: 600;
      }

      .ss-known-inputs,
      .ss-estimate-inputs {
        display: none;
      }

      .ss-known-inputs.show,
      .ss-estimate-inputs.show {
        display: block;
      }

      .ss-info-box {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.08) 0%,
          rgba(118, 75, 162, 0.08) 100%
        );
        border-left: 4px solid #667eea;
        padding: 12px 15px;
        border-radius: 0 6px 6px 0;
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #555;
        line-height: 1.5;
      }

      .ss-result {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        padding: 15px 20px;
        border-radius: 8px;
        text-align: center;
        margin-top: 15px;
      }

      .ss-result-label {
        font-size: 0.9em;
        color: #333;
        margin-bottom: 5px;
      }

      .ss-result-value {
        font-size: 1.5em;
        font-weight: 700;
        color: #00796b;
      }

      /* Simple mode totals display */
      .simple-totals {
        display: none;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.08) 0%,
          rgba(118, 75, 162, 0.08) 100%
        );
        padding: 15px 20px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .simple-totals.show {
        display: block;
      }

      .simple-totals-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(102, 126, 234, 0.2);
      }

      .simple-totals-row:last-child {
        border-bottom: none;
        font-weight: 600;
      }

      /* Gap Analysis & Recommendations */
      .gap-analysis {
        margin-top: 30px;
        padding: 30px;
        background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
        border-radius: 12px;
        border: 2px solid #f97316;
      }

      .gap-analysis h3 {
        color: #9a3412;
        font-size: 1.4em;
        margin-bottom: 12px;
        text-align: center;
      }

      .gap-intro {
        text-align: center;
        color: #7c2d12;
        font-size: 1.05em;
        margin-bottom: 25px;
      }

      .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 20px;
      }

      .recommendation-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 2px solid #fed7aa;
        transition: all 0.3s;
      }

      .recommendation-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        border-color: #fb923c;
      }

      .rec-icon {
        font-size: 2.5em;
        margin-bottom: 12px;
      }

      .rec-title {
        font-size: 1.1em;
        font-weight: 600;
        color: #9a3412;
        margin-bottom: 15px;
      }

      .rec-value {
        font-size: 1.8em;
        font-weight: 700;
        color: #ea580c;
        margin-bottom: 8px;
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .rec-desc {
        font-size: 0.9em;
        color: #78350f;
        margin-bottom: 15px;
        min-height: 40px;
      }

      .rec-action {
        display: inline-block;
        padding: 10px 20px;
        background: #f97316;
        color: white;
        text-decoration: none;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .rec-action:hover {
        background: #ea580c;
      }

      .gap-note {
        background: rgba(255, 255, 255, 0.7);
        padding: 15px 20px;
        border-radius: 8px;
        text-align: center;
        color: #78350f;
        font-size: 0.95em;
        line-height: 1.6;
      }

      @media (max-width: 900px) {
        .recommendations-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
      }

      @media (max-width: 768px) {
        .mode-toggle-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .mode-toggle {
          width: 100%;
        }

        .mode-btn {
          flex: 1;
          text-align: center;
        }

        .account-row {
          grid-template-columns: 1fr;
        }

        .ss-option-toggle {
          flex-direction: column;
        }
      }

      /* Tooltip styles for help icons */
      .help-tooltip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: #e0e7ff;
        border-radius: 50%;
        font-size: 12px;
        color: #4f46e5;
        cursor: help;
        margin-left: 6px;
        position: relative;
        font-weight: bold;
        vertical-align: middle;
      }

      .help-tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: white;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: normal;
        white-space: normal;
        width: max-content;
        max-width: 300px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        line-height: 1.4;
      }

      .help-tooltip:hover::before {
        content: '';
        position: absolute;
        bottom: 115%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #1e293b;
        z-index: 1001;
      }

      /* Input validation warning styles */
      .input-warning {
        border-color: #f59e0b !important;
        background-color: #fffbeb !important;
      }

      .input-warning-message {
        color: #d97706;
        font-size: 0.85em;
        margin-top: 4px;
        padding: 4px 8px;
        background: #fffbeb;
        border-radius: 4px;
        display: block;
      }

      .input-error {
        border-color: #ef4444 !important;
        background-color: #fef2f2 !important;
      }

      .input-error-message {
        color: #dc2626;
        font-size: 0.85em;
        margin-top: 4px;
        padding: 4px 8px;
        background: #fef2f2;
        border-radius: 4px;
        display: block;
      }

      /* Assumptions section */
      .assumptions-note {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 6px 6px 0;
        font-size: 0.9em;
      }

      .assumptions-note h4 {
        color: #334155;
        margin-bottom: 8px;
        font-size: 1em;
      }

      .assumptions-note ul {
        margin: 0;
        padding-left: 20px;
        color: #64748b;
      }

      .assumptions-note li {
        margin: 4px 0;
      }

      .assumptions-note a {
        color: #667eea;
        text-decoration: none;
      }

      .assumptions-note a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Development Warning Banner -->
    <div class="dev-warning" role="alert">
      <span class="dev-warning-icon">‚ö†Ô∏è</span>
      <span class="dev-warning-text">
        <strong>BETA VERSION</strong> - This tool is under active development. Features may change
        and bugs may exist.
        <a
          href="https://github.com/marble-stack/financial-planning/issues"
          target="_blank"
          rel="noopener"
          >Report issues on GitHub</a
        >
      </span>
    </div>

    <nav class="nav-tabs" role="navigation" aria-label="Main navigation">
      <a href="income-allocation.html" class="nav-tab">Budget Planner</a>
      <a href="transaction-analyzer.html" class="nav-tab">Spending Tracker</a>
      <a href="retirement-simulator.html" class="nav-tab active" aria-current="page"
        >Retirement Forecast</a
      >
    </nav>

    <div class="container" role="document">
      <header role="banner">
        <h1>
          <a href="index.html" style="color: inherit; text-decoration: none">Retirement Forecast</a>
        </h1>
        <p>See how your savings might grow with 10,000+ simulated scenarios</p>
      </header>

      <main id="main-content" role="main" class="content">
        <!-- Mode Toggle -->
        <div class="mode-toggle-section">
          <div class="mode-toggle-header">
            <div class="mode-toggle-info">
              <h3>Choose Your Planning Level</h3>
              <p>
                Simple mode uses totals; Advanced mode breaks down by account type for tax-aware
                projections
              </p>
            </div>
            <div class="mode-toggle" role="tablist" aria-label="Planning mode selection">
              <button
                class="mode-btn active"
                id="simpleModeBtn"
                role="tab"
                aria-selected="true"
                aria-controls="simpleInputs"
              >
                Simple
              </button>
              <button
                class="mode-btn"
                id="advancedModeBtn"
                role="tab"
                aria-selected="false"
                aria-controls="advancedInputs"
              >
                Advanced
              </button>
            </div>
          </div>
        </div>

        <!-- Basic Info (always visible) -->
        <div class="input-section">
          <div class="input-group">
            <label for="currentAge">Current Age</label>
            <input type="number" id="currentAge" value="35" min="18" max="100" />
          </div>

          <div class="input-group">
            <label for="retirementAge">Retirement Age</label>
            <input type="number" id="retirementAge" value="65" min="18" max="100" />
          </div>

          <div style="grid-column: 1 / -1; margin-bottom: 10px">
            <label style="font-weight: 600; margin-bottom: 10px; display: block; color: #333"
              >Investment Strategy Preset</label
            >
            <div style="display: flex; gap: 10px; flex-wrap: wrap">
              <button
                type="button"
                class="preset-btn"
                id="presetConservative"
                style="
                  padding: 10px 18px;
                  background: white;
                  border: 2px solid #667eea;
                  color: #667eea;
                  border-radius: 6px;
                  font-size: 0.95em;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                "
              >
                Conservative
              </button>
              <button
                type="button"
                class="preset-btn"
                id="presetBalanced"
                style="
                  padding: 10px 18px;
                  background: white;
                  border: 2px solid #667eea;
                  color: #667eea;
                  border-radius: 6px;
                  font-size: 0.95em;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                "
              >
                Balanced
              </button>
              <button
                type="button"
                class="preset-btn"
                id="presetAggressive"
                style="
                  padding: 10px 18px;
                  background: white;
                  border: 2px solid #667eea;
                  color: #667eea;
                  border-radius: 6px;
                  font-size: 0.95em;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.2s;
                "
              >
                Aggressive
              </button>
            </div>
            <small style="color: #666; margin-top: 6px; display: block"
              >Quickly set growth and volatility assumptions based on portfolio mix</small
            >
          </div>

          <div class="input-group">
            <label for="expectedReturn"
              >Expected Annual Growth (%)
              <span
                class="help-tooltip"
                data-tooltip="Historical S&P 500: ~10% nominal, ~7% real (inflation-adjusted). Bond-heavy portfolios: 4-6%. This is before inflation."
                >?</span
              >
            </label>
            <input type="number" id="expectedReturn" value="7" min="-20" max="30" step="0.1" />
            <small>Stock market historically averages 7-10% per year</small>
          </div>

          <div class="input-group">
            <label for="returnVolatility"
              >Return Volatility (%)
              <span
                class="help-tooltip"
                data-tooltip="Standard deviation of annual returns. S&P 500: ~15%. Balanced (60/40): ~10%. Bonds only: ~5%. Higher volatility = more uncertain outcomes."
                >?</span
              >
            </label>
            <input type="number" id="returnVolatility" value="12" min="0" max="50" step="0.1" />
            <small>How much returns swing year-to-year (12% is typical for stocks)</small>
          </div>

          <div class="input-group">
            <label for="inflationRate">Inflation Rate (%)</label>
            <input type="number" id="inflationRate" value="3" min="0" max="20" step="0.1" />
            <small>How fast prices rise each year (3% is historically normal)</small>
          </div>

          <div class="input-group">
            <label for="stateSelect">State (for state income tax)</label>
            <select id="stateSelect">
              <option value="">-- No State Tax --</option>
              <option value="AL">Alabama (5.0%)</option>
              <option value="AK">Alaska (No tax)</option>
              <option value="AZ">Arizona (2.5%)</option>
              <option value="AR">Arkansas (4.4%)</option>
              <option value="CA">California (13.3%)</option>
              <option value="CO">Colorado (4.4%)</option>
              <option value="CT">Connecticut (7.0%)</option>
              <option value="DE">Delaware (6.6%)</option>
              <option value="FL">Florida (No tax)</option>
              <option value="GA">Georgia (5.5%)</option>
              <option value="HI">Hawaii (11.0%)</option>
              <option value="ID">Idaho (5.8%)</option>
              <option value="IL">Illinois (5.0%)</option>
              <option value="IN">Indiana (3.1%)</option>
              <option value="IA">Iowa (5.8%)</option>
              <option value="KS">Kansas (5.7%)</option>
              <option value="KY">Kentucky (4.0%)</option>
              <option value="LA">Louisiana (4.3%)</option>
              <option value="ME">Maine (7.2%)</option>
              <option value="MD">Maryland (5.8%)</option>
              <option value="MA">Massachusetts (5.0%)</option>
              <option value="MI">Michigan (4.3%)</option>
              <option value="MN">Minnesota (9.9%)</option>
              <option value="MS">Mississippi (5.0%)</option>
              <option value="MO">Missouri (4.8%)</option>
              <option value="MT">Montana (5.9%)</option>
              <option value="NE">Nebraska (5.8%)</option>
              <option value="NV">Nevada (No tax)</option>
              <option value="NH">New Hampshire (No tax)</option>
              <option value="NJ">New Jersey (10.8%)</option>
              <option value="NM">New Mexico (5.9%)</option>
              <option value="NY">New York (10.9%)</option>
              <option value="NC">North Carolina (4.8%)</option>
              <option value="ND">North Dakota (2.5%)</option>
              <option value="OH">Ohio (3.5%)</option>
              <option value="OK">Oklahoma (4.8%)</option>
              <option value="OR">Oregon (9.9%)</option>
              <option value="PA">Pennsylvania (3.1%)</option>
              <option value="RI">Rhode Island (6.0%)</option>
              <option value="SC">South Carolina (6.4%)</option>
              <option value="SD">South Dakota (No tax)</option>
              <option value="TN">Tennessee (No tax)</option>
              <option value="TX">Texas (No tax)</option>
              <option value="UT">Utah (4.7%)</option>
              <option value="VT">Vermont (8.8%)</option>
              <option value="VA">Virginia (5.8%)</option>
              <option value="WA">Washington (No tax)</option>
              <option value="WV">West Virginia (5.1%)</option>
              <option value="WI">Wisconsin (7.7%)</option>
              <option value="WY">Wyoming (No tax)</option>
              <option value="DC">DC (10.8%)</option>
            </select>
            <small>State tax is applied to traditional account withdrawals</small>
          </div>

          <div
            id="realReturnDisplay"
            style="
              background: #e0f2fe;
              border-left: 4px solid #0284c7;
              padding: 12px 15px;
              border-radius: 6px;
              margin: 10px 0 20px 0;
            "
          >
            <strong style="color: #0369a1"
              >Real Return ‚âà <span id="realReturnValue">4.0</span>%</strong
            >
            <small style="display: block; color: #0c4a6e; margin-top: 4px"
              >Growth minus inflation ‚Äî your actual purchasing power increase</small
            >
          </div>

          <div class="input-group">
            <label for="annualSpending">Annual Spending in Retirement</label>
            <input
              type="text"
              id="annualSpending"
              value="$60,000.00"
              inputmode="decimal"
              autocomplete="off"
            />
            <small>Will be adjusted for inflation</small>
          </div>

          <div class="input-group">
            <label for="yearsInRetirement"
              >Years in Retirement
              <span
                class="help-tooltip"
                data-tooltip="Average US life expectancy at 65 is 84 (men) to 87 (women). For planning, add 5+ years to account for longevity risk."
                >?</span
              >
            </label>
            <input type="number" id="yearsInRetirement" value="30" min="1" max="60" />
            <small>Life expectancy minus retirement age</small>
          </div>

          <div class="input-group">
            <label for="numSimulations">Number of Simulations</label>
            <input
              type="number"
              id="numSimulations"
              value="10000"
              min="1000"
              max="50000"
              step="1000"
            />
            <small>More = stable results but slower (10k is usually sufficient)</small>
          </div>
        </div>

        <!-- Simple Mode Inputs -->
        <div
          id="simpleInputs"
          class="section-wrapper"
          role="tabpanel"
          aria-labelledby="simpleModeBtn"
        >
          <div class="input-section">
            <div class="input-group">
              <label for="currentSavings">Current Retirement Savings</label>
              <input
                type="text"
                id="currentSavings"
                value="$100,000.00"
                inputmode="decimal"
                autocomplete="off"
              />
              <small>Total across all retirement accounts</small>
            </div>

            <div class="input-group">
              <label for="annualContribution">Annual Contribution Until Retirement</label>
              <input
                type="text"
                id="annualContribution"
                value="$15,000.00"
                inputmode="decimal"
                autocomplete="off"
              />
              <small>Total yearly contributions to all accounts</small>
            </div>
          </div>
        </div>

        <!-- Advanced Mode Inputs -->
        <div
          id="advancedInputs"
          class="section-wrapper"
          role="tabpanel"
          aria-labelledby="advancedModeBtn"
          style="display: none"
        >
          <!-- Current Savings Breakdown -->
          <div class="section-wrapper">
            <div
              class="section-header expanded"
              id="savingsHeader"
              aria-expanded="true"
              aria-controls="savingsContent"
            >
              <span class="section-icon" aria-hidden="true">üí∞</span>
              <h3>Current Savings by Account Type</h3>
              <span class="toggle-arrow" aria-hidden="true">‚ñº</span>
            </div>
            <div class="section-content show" id="savingsContent">
              <div class="account-group">
                <div class="account-group-title">401(k) Accounts</div>
                <div class="account-row">
                  <div class="input-group">
                    <label for="traditional401k">Traditional 401(k)</label>
                    <input
                      type="text"
                      id="traditional401k"
                      value="$50,000.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                    <small>Pre-tax contributions, taxed on withdrawal</small>
                  </div>
                  <div class="input-group">
                    <label for="roth401k">Roth 401(k)</label>
                    <input
                      type="text"
                      id="roth401k"
                      value="$0.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                    <small>After-tax contributions, tax-free growth</small>
                  </div>
                </div>
              </div>

              <div class="account-group">
                <div class="account-group-title">IRA Accounts</div>
                <div class="account-row">
                  <div class="input-group">
                    <label for="traditionalIRA">Traditional IRA</label>
                    <input
                      type="text"
                      id="traditionalIRA"
                      value="$25,000.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                    <small>Pre-tax contributions, taxed on withdrawal</small>
                  </div>
                  <div class="input-group">
                    <label for="rothIRA">Roth IRA</label>
                    <input
                      type="text"
                      id="rothIRA"
                      value="$15,000.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                    <small>After-tax contributions, tax-free growth</small>
                  </div>
                </div>
              </div>

              <div class="account-group">
                <div class="account-group-title">Taxable Accounts</div>
                <div class="account-row">
                  <div class="input-group">
                    <label for="taxableBrokerage">Taxable Brokerage</label>
                    <input
                      type="text"
                      id="taxableBrokerage"
                      value="$10,000.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                    <small>Regular investment account, capital gains taxed</small>
                  </div>
                  <div class="input-group">
                    <!-- Placeholder for layout -->
                  </div>
                </div>
              </div>

              <div class="simple-totals show" id="savingsTotals">
                <div class="simple-totals-row">
                  <span>Pre-tax (Traditional)</span>
                  <span id="totalPreTax">$75,000.00</span>
                </div>
                <div class="simple-totals-row">
                  <span>Tax-free (Roth)</span>
                  <span id="totalRoth">$15,000.00</span>
                </div>
                <div class="simple-totals-row">
                  <span>Taxable</span>
                  <span id="totalTaxable">$10,000.00</span>
                </div>
                <div class="simple-totals-row">
                  <span>Total Savings</span>
                  <span id="totalSavings">$100,000.00</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Annual Contributions Breakdown -->
          <div class="section-wrapper">
            <div
              class="section-header expanded"
              id="contributionsHeader"
              aria-expanded="true"
              aria-controls="contributionsContent"
            >
              <span class="section-icon" aria-hidden="true">üìà</span>
              <h3>Annual Contributions by Account Type</h3>
              <span class="toggle-arrow" aria-hidden="true">‚ñº</span>
            </div>
            <div class="section-content show" id="contributionsContent">
              <div class="account-group">
                <div class="account-group-title">401(k) Contributions</div>
                <div class="account-row">
                  <div class="input-group">
                    <label for="contribTraditional401k">Traditional 401(k)</label>
                    <input
                      type="text"
                      id="contribTraditional401k"
                      value="$10,000.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                  </div>
                  <div class="input-group">
                    <label for="contribRoth401k">Roth 401(k)</label>
                    <input
                      type="text"
                      id="contribRoth401k"
                      value="$0.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                  </div>
                </div>
              </div>

              <div class="account-group">
                <div class="account-group-title">IRA Contributions</div>
                <div class="account-row">
                  <div class="input-group">
                    <label for="contribTraditionalIRA">Traditional IRA</label>
                    <input
                      type="text"
                      id="contribTraditionalIRA"
                      value="$0.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                  </div>
                  <div class="input-group">
                    <label for="contribRothIRA">Roth IRA</label>
                    <input
                      type="text"
                      id="contribRothIRA"
                      value="$5,000.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                  </div>
                </div>
              </div>

              <div class="account-group">
                <div class="account-group-title">Taxable Contributions</div>
                <div class="account-row">
                  <div class="input-group">
                    <label for="contribTaxable">Taxable Brokerage</label>
                    <input
                      type="text"
                      id="contribTaxable"
                      value="$0.00"
                      inputmode="decimal"
                      autocomplete="off"
                    />
                  </div>
                  <div class="input-group">
                    <!-- Placeholder for layout -->
                  </div>
                </div>
              </div>

              <div class="simple-totals show" id="contributionsTotals">
                <div class="simple-totals-row">
                  <span>Total Annual Contributions</span>
                  <span id="totalContributions">$15,000.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Social Security Section -->
        <div class="section-wrapper">
          <div class="section-header" id="ssHeader" aria-expanded="false" aria-controls="ssContent">
            <span class="section-icon" aria-hidden="true">üèõÔ∏è</span>
            <h3>Social Security (Optional)</h3>
            <span class="toggle-arrow" aria-hidden="true">‚ñº</span>
          </div>
          <div class="section-content" id="ssContent">
            <div class="ss-option-toggle">
              <button class="ss-option-btn" id="ssNoneBtn">Don't Include</button>
              <button class="ss-option-btn" id="ssKnownBtn">I Know My Benefit</button>
              <button class="ss-option-btn" id="ssEstimateBtn">Estimate For Me</button>
            </div>

            <!-- Known SS Benefit -->
            <div class="ss-known-inputs" id="ssKnownInputs">
              <div class="ss-info-box">
                You can find your estimated benefit on your Social Security statement at
                ssa.gov/myaccount
              </div>
              <div class="input-section">
                <div class="input-group">
                  <label for="ssMonthlyBenefit">Monthly Benefit at Full Retirement Age</label>
                  <input
                    type="text"
                    id="ssMonthlyBenefit"
                    value="$2,000.00"
                    inputmode="decimal"
                    autocomplete="off"
                  />
                  <small>Your Primary Insurance Amount (PIA)</small>
                </div>
                <div class="input-group">
                  <label for="ssStartAge">Age You'll Start Collecting</label>
                  <input type="number" id="ssStartAge" value="67" min="62" max="70" />
                  <small>Early (62) = reduced; Late (70) = increased</small>
                </div>
              </div>
              <div class="ss-result" id="ssKnownResult">
                <div class="ss-result-label">Adjusted Monthly Benefit</div>
                <div class="ss-result-value" id="ssAdjustedBenefit">$2,000/mo</div>
              </div>
            </div>

            <!-- Estimate SS Benefit -->
            <div class="ss-estimate-inputs" id="ssEstimateInputs">
              <div class="ss-info-box">
                We'll estimate your benefit based on your current income. This is a rough
                approximation - for accuracy, check ssa.gov/myaccount
              </div>
              <div class="input-section">
                <div class="input-group">
                  <label for="ssCurrentIncome">Current Annual Income</label>
                  <input
                    type="text"
                    id="ssCurrentIncome"
                    value="$75,000.00"
                    inputmode="decimal"
                    autocomplete="off"
                  />
                  <small>Your W-2 or self-employment income</small>
                </div>
                <div class="input-group">
                  <label for="ssWorkYears">Career Length (Years)</label>
                  <input type="number" id="ssWorkYears" value="35" min="0" max="50" />
                  <small
                    >SSA uses your highest 35 years of earnings. If you have fewer than 35 years,
                    zeros are averaged in, reducing your benefit.</small
                  >
                </div>
                <div class="input-group">
                  <label for="ssEstStartAge">Age You'll Start Collecting</label>
                  <input type="number" id="ssEstStartAge" value="67" min="62" max="70" />
                  <small>Early (62) = reduced; Late (70) = increased</small>
                </div>
              </div>
              <div class="ss-result" id="ssEstimateResult">
                <div class="ss-result-label">Estimated Monthly Benefit</div>
                <div class="ss-result-value" id="ssEstimatedBenefit">$1,850/mo</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Life Events Section -->
        <div class="life-events-section">
          <button
            class="toggle-events-btn"
            id="toggleEvents"
            aria-expanded="false"
            aria-controls="eventsPanel"
          >
            <span aria-hidden="true">üìÖ</span> Add Life Events (optional but makes your forecast
            more realistic)
            <span class="arrow" aria-hidden="true">‚ñº</span>
          </button>

          <div class="events-panel" id="eventsPanel" aria-labelledby="toggleEvents">
            <p class="events-description">
              Planning to help pay for kids' college? Expecting an inheritance? Want to work
              part-time in early retirement? Add those here to see how they affect your forecast.
            </p>

            <div class="events-controls">
              <button class="add-event-btn" id="addEvent" aria-label="Add a new life event">
                + Add Event
              </button>
              <div class="event-presets">
                <span style="font-size: 0.85em; color: #666; align-self: center">Quick add:</span>
                <button
                  class="event-preset-btn"
                  id="presetChild"
                  aria-label="Add child expense preset"
                >
                  Child ($500K over 18yr)
                </button>
                <button
                  class="event-preset-btn"
                  id="presetHouse"
                  aria-label="Add house purchase preset"
                >
                  Buy a House ($1M)
                </button>
                <button
                  class="event-preset-btn"
                  id="presetPartTime"
                  aria-label="Add part-time work income preset"
                >
                  Part-Time in Retirement ($30K/yr)
                </button>
              </div>
            </div>

            <div id="eventsList" class="events-list" role="list"></div>
          </div>
        </div>

        <!-- Assumptions Documentation -->
        <div class="assumptions-note">
          <h4>Key Assumptions in This Simulation</h4>
          <ul>
            <li>
              <strong>Tax Rates:</strong> Uses 2024 federal brackets. State tax applied to
              traditional withdrawals only.
            </li>
            <li>
              <strong>RMDs:</strong> Required Minimum Distributions enforced at age 73+ per SECURE
              2.0 Act.
            </li>
            <li>
              <strong>Social Security:</strong> Uses 2024 bend points and adjusts benefits for
              early/delayed claiming per SSA rules.
            </li>
            <li>
              <strong>Inflation:</strong> Spending and Social Security COLA increase at the
              specified rate annually.
            </li>
            <li>
              <strong>Withdrawal Order:</strong> Taxable accounts first, then traditional (pre-tax),
              then Roth (tax-free).
            </li>
            <li>
              <strong>Monte Carlo:</strong> Returns are randomly generated using a normal
              distribution with your specified mean and volatility.
            </li>
          </ul>
          <small style="display: block; margin-top: 10px; color: #94a3b8">
            Sources: <a href="https://www.ssa.gov" target="_blank" rel="noopener">SSA.gov</a> |
            <a href="https://www.irs.gov/publications/p590b" target="_blank" rel="noopener"
              >IRS Pub 590-B</a
            >
            | Tax Foundation
          </small>
        </div>

        <div class="button-container">
          <button
            id="runSimulation"
            aria-label="Run Monte Carlo simulation with current parameters"
          >
            Run Simulation
          </button>
        </div>

        <div
          class="progress"
          id="progress"
          role="status"
          aria-live="polite"
          aria-atomic="true"
        ></div>

        <div class="results" id="results" role="region" aria-label="Simulation results">
          <div class="stats-grid">
            <div class="stat-card success">
              <h3>Success Rate</h3>
              <div class="value" id="successRate">-</div>
              <div class="description">
                Chance your savings last your entire retirement. Above 80% is generally considered
                good!
              </div>
            </div>
            <div class="stat-card">
              <h3>Typical Ending Balance</h3>
              <div class="value" id="medianBalance">-</div>
              <div class="description">
                What you'd likely have left at age <span id="endAge">95</span> (half of scenarios
                end higher, half lower)
              </div>
            </div>
            <div class="stat-card">
              <h3>If Markets Struggle</h3>
              <div class="value" id="percentile10">-</div>
              <div class="description">
                In a rough economy, you might end with this much (only 10% of scenarios are worse)
              </div>
            </div>
            <div class="stat-card">
              <h3>If Markets Thrive</h3>
              <div class="value" id="percentile90">-</div>
              <div class="description">
                In a great economy, you could end with this much (only 10% of scenarios are better)
              </div>
            </div>
          </div>

          <div class="chart-container">
            <h3>Distribution of Ending Balances (Inflation-Adjusted)</h3>
            <p style="color: #666; font-size: 0.95em; margin-bottom: 15px">
              This histogram shows how many of the 10,000 simulations ended with each balance range.
              A large bar at $0 indicates scenarios where you ran out of money before age 95.
            </p>
            <div class="chart-wrapper">
              <canvas
                id="histogramChart"
                role="img"
                aria-label="Histogram showing distribution of ending portfolio balances across all simulations"
              ></canvas>
            </div>
            <div class="chart-actions">
              <button
                class="download-chart-btn"
                id="downloadHistogram"
                aria-label="Download histogram chart as PNG image"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Download PNG
              </button>
            </div>
            <!-- Accessible data table for screen readers -->
            <details style="margin-top: 15px">
              <summary style="cursor: pointer; color: #667eea; font-size: 0.9em">
                View chart data as table (for accessibility)
              </summary>
              <div
                id="histogramDataTable"
                style="margin-top: 10px; font-size: 0.85em; max-height: 200px; overflow-y: auto"
              ></div>
            </details>
          </div>

          <div class="chart-container">
            <h3>Portfolio Projection with Confidence Bands</h3>
            <div class="chart-wrapper">
              <canvas
                id="pathsChart"
                role="img"
                aria-label="Line chart showing median portfolio trajectory with confidence intervals from 10th to 90th percentile"
              ></canvas>
            </div>
            <div class="chart-actions">
              <button
                class="download-chart-btn"
                id="downloadPaths"
                aria-label="Download projection chart as PNG image"
              >
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                Download PNG
              </button>
            </div>
            <!-- Accessible data table for screen readers -->
            <details style="margin-top: 15px">
              <summary style="cursor: pointer; color: #667eea; font-size: 0.9em">
                View chart data as table (for accessibility)
              </summary>
              <div
                id="pathsDataTable"
                style="margin-top: 10px; font-size: 0.85em; max-height: 200px; overflow-y: auto"
              ></div>
            </details>
            <div
              style="
                background: #f0f4f8;
                padding: 20px;
                border-radius: 8px;
                margin-top: 20px;
                border-left: 4px solid #667eea;
              "
            >
              <h4 style="color: #333; font-size: 1.1em; margin-bottom: 12px">
                üìä How to Read This Chart
              </h4>
              <ul style="color: #555; font-size: 0.95em; line-height: 1.8; margin-left: 20px">
                <li>
                  <strong>Bold blue line (Median):</strong> The most likely path - half of
                  simulations end above this, half below
                </li>
                <li>
                  <strong>Dark blue band (25th-75th):</strong> The middle 50% of outcomes fall
                  within this range
                </li>
                <li>
                  <strong>Light blue band (10th-90th):</strong> 80% of all possible outcomes fall
                  within this wider range
                </li>
                <li>
                  <strong style="color: #dc3545">Red dashed line ($0 Threshold):</strong> If bands
                  cross this line, you risk running out of money
                </li>
                <li>
                  <strong>Width of bands = uncertainty:</strong> Wider bands mean more variability
                  in potential outcomes
                </li>
              </ul>
              <p style="color: #666; font-size: 0.9em; margin-top: 12px; font-style: italic">
                üí° If the bands stay above $0 through retirement, you have a strong plan. If they
                dip to $0, consider saving more or reducing planned spending.
              </p>
            </div>
          </div>

          <!-- Gap Analysis & Recommendations -->
          <div id="gapAnalysis" class="gap-analysis" style="display: none">
            <h3>üéØ How to Reach 90% Success Rate</h3>
            <p class="gap-intro">
              Your current success rate is below the recommended 90% target. Here are three ways to
              improve your chances:
            </p>

            <div class="recommendations-grid">
              <div class="recommendation-card">
                <div class="rec-icon">üí∞</div>
                <div class="rec-title">Option 1: Save More</div>
                <div class="rec-value" id="recSaveMore">--</div>
                <div class="rec-desc">Increase monthly retirement savings</div>
                <a href="income-allocation.html" class="rec-action">Adjust Budget ‚Üí</a>
              </div>

              <div class="recommendation-card">
                <div class="rec-icon">‚è∞</div>
                <div class="rec-title">Option 2: Work Longer</div>
                <div class="rec-value" id="recWorkLonger">--</div>
                <div class="rec-desc">Delay retirement by additional years</div>
                <button class="rec-action" onclick="applyWorkLongerRecommendation()">
                  Try This ‚Üí
                </button>
              </div>

              <div class="recommendation-card">
                <div class="rec-icon">üìâ</div>
                <div class="rec-title">Option 3: Spend Less</div>
                <div class="rec-value" id="recSpendLess">--</div>
                <div class="rec-desc">Reduce annual retirement spending</div>
                <button class="rec-action" onclick="applySpendLessRecommendation()">
                  Try This ‚Üí
                </button>
              </div>
            </div>

            <div class="gap-note">
              üí° <strong>Tip:</strong> Combining multiple approaches often works best. Even small
              changes in each area can add up to a significant improvement.
            </div>
          </div>
        </div>
      </main>

      <footer role="contentinfo">
        <p class="disclaimer">
          <strong>Disclaimer:</strong> This tool is for educational purposes only and does not
          constitute financial advice. Actual investment returns vary and past performance does not
          guarantee future results. Please consult with a qualified financial advisor for
          personalized retirement planning.
        </p>
        <nav class="workflow-nav" aria-label="Workflow navigation">
          <a href="transaction-analyzer.html" class="nav-arrow">‚Üê Back to Spending Tracker</a>
          <a href="index.html" class="home-link">üè† Home</a>
        </nav>
        <p class="version-text">v2025.12.30 12:47 PM</p>
      </footer>
    </div>

    <script type="module">
      // Import business logic from tested lib/ modules
      import { SocialSecurityCalculator } from './lib/social-security.js';
      import {
        generateNormalRandom,
        getLifeEventImpact,
        calculateTaxRate,
        calculateRMD,
        applyRMD,
        RMD_START_AGE,
      } from './lib/simulation.js';
      import { RetirementSimulator } from './lib/retirement-simulator.js';

      // Life Events Manager
      class LifeEventsManager {
        constructor() {
          this.events = [];
          // Restore counter from localStorage to prevent duplicate IDs
          this.eventIdCounter = parseInt(StorageUtils.get('lifeEventIdCounter', 0)) || 0;
        }

        addEvent(event = {}) {
          // If event already has an ID (from session restore), use it and update counter if needed
          const eventId = event.id !== undefined ? event.id : this.eventIdCounter++;
          if (eventId >= this.eventIdCounter) {
            this.eventIdCounter = eventId + 1;
          }
          // Persist counter
          StorageUtils.set('lifeEventIdCounter', this.eventIdCounter);

          const newEvent = {
            id: eventId,
            name: event.name || '',
            type: event.type || 'expense',
            amount: event.amount || 0,
            startAge: event.startAge || 35,
            duration: event.duration || 1,
          };
          this.events.push(newEvent);
          return newEvent;
        }

        removeEvent(id) {
          this.events = this.events.filter((e) => e.id !== id);
        }

        updateEvent(id, field, value) {
          const event = this.events.find((e) => e.id === id);
          if (event) {
            event[field] = value;
          }
        }

        getEvents() {
          return this.events;
        }
      }

      // UI Controller
      class SimulatorUI {
        constructor() {
          this.histogramChart = null;
          this.pathsChart = null;
          this.eventsManager = new LifeEventsManager();
          this.ssCalculator = new SocialSecurityCalculator();
          this.advancedMode = false;
          this.ssMode = 'none'; // 'none', 'known', 'estimate'
          this.setupEventListeners();
          this.setupModeToggle();
          this.setupSocialSecurity();
          this.setupSectionToggles();
        }

        setupEventListeners() {
          document.getElementById('runSimulation').addEventListener('click', () => {
            this.runSimulation();
          });

          // Chart download buttons
          document.getElementById('downloadHistogram').addEventListener('click', () => {
            this.downloadChart('histogramChart', 'retirement-distribution.png');
          });
          document.getElementById('downloadPaths').addEventListener('click', () => {
            this.downloadChart('pathsChart', 'retirement-projection.png');
          });

          // Currency formatting for simple mode inputs
          const simpleCurrencyInputs = ['currentSavings', 'annualContribution', 'annualSpending'];
          simpleCurrencyInputs.forEach((inputId) => {
            const input = document.getElementById(inputId);
            if (input) {
              input.addEventListener('focus', (e) => {
                const value = this.parseCurrencyValue(e.target.value);
                e.target.value = value > 0 ? value.toFixed(2) : '';
              });
              input.addEventListener('blur', (e) => {
                const value = this.parseCurrencyValue(e.target.value);
                e.target.value = this.formatCurrencyInput(value);
              });
            }
          });

          // Currency formatting for advanced mode inputs
          const advancedCurrencyInputs = [
            'traditional401k',
            'roth401k',
            'traditionalIRA',
            'rothIRA',
            'taxableBrokerage',
            'contribTraditional401k',
            'contribRoth401k',
            'contribTraditionalIRA',
            'contribRothIRA',
            'contribTaxable',
            'ssMonthlyBenefit',
            'ssCurrentIncome',
          ];
          advancedCurrencyInputs.forEach((inputId) => {
            const input = document.getElementById(inputId);
            if (input) {
              input.addEventListener('focus', (e) => {
                const value = this.parseCurrencyValue(e.target.value);
                e.target.value = value > 0 ? value.toFixed(2) : '';
              });
              input.addEventListener('blur', (e) => {
                const value = this.parseCurrencyValue(e.target.value);
                e.target.value = this.formatCurrencyInput(value);
                this.updateAdvancedTotals();
              });
              input.addEventListener('input', () => {
                this.updateAdvancedTotals();
              });
            }
          });

          // Life events toggle
          document.getElementById('toggleEvents').addEventListener('click', () => {
            this.toggleEventsPanel();
          });

          // Add event button
          document.getElementById('addEvent').addEventListener('click', () => {
            this.addLifeEvent();
          });

          // Life event preset buttons
          document.getElementById('presetChild').addEventListener('click', () => {
            const currentAge = parseInt(document.getElementById('currentAge').value) || 35;
            this.addLifeEvent({
              name: 'Raising a Child',
              type: 'expense',
              amount: 28000,
              startAge: currentAge + 1,
              duration: 18,
            });
            this.ensureEventsPanelOpen();
          });

          document.getElementById('presetHouse').addEventListener('click', () => {
            const currentAge = parseInt(document.getElementById('currentAge').value) || 35;
            this.addLifeEvent({
              name: 'House Purchase',
              type: 'expense',
              amount: 1000000,
              startAge: currentAge + 2,
              duration: 1,
            });
            this.ensureEventsPanelOpen();
          });

          document.getElementById('presetPartTime').addEventListener('click', () => {
            const retirementAge = parseInt(document.getElementById('retirementAge').value) || 65;
            this.addLifeEvent({
              name: 'Part-Time Work',
              type: 'income',
              amount: 30000,
              startAge: retirementAge,
              duration: 5,
            });
            this.ensureEventsPanelOpen();
          });
        }

        setupModeToggle() {
          const simpleBtn = document.getElementById('simpleModeBtn');
          const advancedBtn = document.getElementById('advancedModeBtn');
          const simpleInputs = document.getElementById('simpleInputs');
          const advancedInputs = document.getElementById('advancedInputs');

          simpleBtn.addEventListener('click', () => {
            this.advancedMode = false;
            simpleBtn.classList.add('active');
            simpleBtn.setAttribute('aria-selected', 'true');
            advancedBtn.classList.remove('active');
            advancedBtn.setAttribute('aria-selected', 'false');
            simpleInputs.style.display = 'block';
            advancedInputs.style.display = 'none';
          });

          advancedBtn.addEventListener('click', () => {
            this.advancedMode = true;
            advancedBtn.classList.add('active');
            advancedBtn.setAttribute('aria-selected', 'true');
            simpleBtn.classList.remove('active');
            simpleBtn.setAttribute('aria-selected', 'false');
            simpleInputs.style.display = 'none';
            advancedInputs.style.display = 'block';
            this.updateAdvancedTotals();
          });
        }

        setupSectionToggles() {
          // Collapsible sections
          const sections = [
            { header: 'savingsHeader', content: 'savingsContent' },
            { header: 'contributionsHeader', content: 'contributionsContent' },
            { header: 'ssHeader', content: 'ssContent' },
          ];

          sections.forEach(({ header, content }) => {
            const headerEl = document.getElementById(header);
            const contentEl = document.getElementById(content);
            if (headerEl && contentEl) {
              headerEl.addEventListener('click', () => {
                const isExpanded = contentEl.classList.toggle('show');
                headerEl.classList.toggle('expanded', isExpanded);
                headerEl.setAttribute('aria-expanded', isExpanded);
              });
            }
          });
        }

        setupSocialSecurity() {
          const ssNoneBtn = document.getElementById('ssNoneBtn');
          const ssKnownBtn = document.getElementById('ssKnownBtn');
          const ssEstimateBtn = document.getElementById('ssEstimateBtn');
          const ssKnownInputs = document.getElementById('ssKnownInputs');
          const ssEstimateInputs = document.getElementById('ssEstimateInputs');

          const updateSSMode = (mode) => {
            this.ssMode = mode;
            [ssNoneBtn, ssKnownBtn, ssEstimateBtn].forEach((btn) => btn.classList.remove('active'));
            ssKnownInputs.classList.remove('show');
            ssEstimateInputs.classList.remove('show');

            if (mode === 'none') {
              ssNoneBtn.classList.add('active');
            } else if (mode === 'known') {
              ssKnownBtn.classList.add('active');
              ssKnownInputs.classList.add('show');
              this.updateKnownSSBenefit();
            } else if (mode === 'estimate') {
              ssEstimateBtn.classList.add('active');
              ssEstimateInputs.classList.add('show');
              this.updateEstimatedSSBenefit();
            }
          };

          ssNoneBtn.addEventListener('click', () => updateSSMode('none'));
          ssKnownBtn.addEventListener('click', () => updateSSMode('known'));
          ssEstimateBtn.addEventListener('click', () => updateSSMode('estimate'));

          // Update SS benefit when inputs change
          ['ssMonthlyBenefit', 'ssStartAge'].forEach((id) => {
            const el = document.getElementById(id);
            if (el) {
              el.addEventListener('input', () => this.updateKnownSSBenefit());
              el.addEventListener('blur', () => this.updateKnownSSBenefit());
            }
          });

          ['ssCurrentIncome', 'ssWorkYears', 'ssEstStartAge'].forEach((id) => {
            const el = document.getElementById(id);
            if (el) {
              el.addEventListener('input', () => this.updateEstimatedSSBenefit());
              el.addEventListener('blur', () => this.updateEstimatedSSBenefit());
            }
          });

          // Set default to "Don't Include"
          updateSSMode('none');
        }

        updateKnownSSBenefit() {
          const pia = this.parseCurrencyValue(document.getElementById('ssMonthlyBenefit').value);
          const startAge = parseInt(document.getElementById('ssStartAge').value) || 67;
          const currentAge = parseInt(document.getElementById('currentAge').value) || 35;
          // Approximate birth year (assumes user has had birthday this year; variance is minimal for SS calculations)
          const birthYear = new Date().getFullYear() - currentAge;

          const fra = this.ssCalculator.getFullRetirementAge(birthYear);
          const adjustedBenefit = this.ssCalculator.adjustBenefitForAge(pia, startAge, fra);

          document.getElementById('ssAdjustedBenefit').textContent =
            '$' + Math.round(adjustedBenefit).toLocaleString() + '/mo';
        }

        updateEstimatedSSBenefit() {
          const income = this.parseCurrencyValue(document.getElementById('ssCurrentIncome').value);
          const workYears = parseInt(document.getElementById('ssWorkYears').value) || 15;
          const startAge = parseInt(document.getElementById('ssEstStartAge').value) || 67;
          const currentAge = parseInt(document.getElementById('currentAge').value) || 35;
          const birthYear = new Date().getFullYear() - currentAge;

          const pia = this.ssCalculator.estimatePIA(income, workYears);
          const fra = this.ssCalculator.getFullRetirementAge(birthYear);
          const adjustedBenefit = this.ssCalculator.adjustBenefitForAge(pia, startAge, fra);

          document.getElementById('ssEstimatedBenefit').textContent =
            '$' + Math.round(adjustedBenefit).toLocaleString() + '/mo';
        }

        updateAdvancedTotals() {
          // Update savings totals
          const trad401k = this.parseCurrencyValue(
            document.getElementById('traditional401k').value
          );
          const roth401k = this.parseCurrencyValue(document.getElementById('roth401k').value);
          const tradIRA = this.parseCurrencyValue(document.getElementById('traditionalIRA').value);
          const rothIRA = this.parseCurrencyValue(document.getElementById('rothIRA').value);
          const taxable = this.parseCurrencyValue(
            document.getElementById('taxableBrokerage').value
          );

          const totalPreTax = trad401k + tradIRA;
          const totalRoth = roth401k + rothIRA;
          const totalSavings = totalPreTax + totalRoth + taxable;

          document.getElementById('totalPreTax').textContent =
            this.formatCurrencyInput(totalPreTax);
          document.getElementById('totalRoth').textContent = this.formatCurrencyInput(totalRoth);
          document.getElementById('totalTaxable').textContent = this.formatCurrencyInput(taxable);
          document.getElementById('totalSavings').textContent =
            this.formatCurrencyInput(totalSavings);

          // Update contributions totals
          const cTrad401k = this.parseCurrencyValue(
            document.getElementById('contribTraditional401k').value
          );
          const cRoth401k = this.parseCurrencyValue(
            document.getElementById('contribRoth401k').value
          );
          const cTradIRA = this.parseCurrencyValue(
            document.getElementById('contribTraditionalIRA').value
          );
          const cRothIRA = this.parseCurrencyValue(document.getElementById('contribRothIRA').value);
          const cTaxable = this.parseCurrencyValue(document.getElementById('contribTaxable').value);

          const totalContributions = cTrad401k + cRoth401k + cTradIRA + cRothIRA + cTaxable;
          document.getElementById('totalContributions').textContent =
            this.formatCurrencyInput(totalContributions);
        }

        getSSParams() {
          if (this.ssMode === 'none') {
            return { ssAnnualBenefit: 0, ssStartAge: null };
          }

          const currentAge = parseInt(document.getElementById('currentAge').value) || 35;
          const birthYear = new Date().getFullYear() - currentAge;
          const fra = this.ssCalculator.getFullRetirementAge(birthYear);

          if (this.ssMode === 'known') {
            const pia = this.parseCurrencyValue(document.getElementById('ssMonthlyBenefit').value);
            const startAge = parseInt(document.getElementById('ssStartAge').value) || 67;
            const adjustedMonthly = this.ssCalculator.adjustBenefitForAge(pia, startAge, fra);
            return {
              ssAnnualBenefit: adjustedMonthly * 12,
              ssStartAge: startAge,
            };
          } else {
            const income = this.parseCurrencyValue(
              document.getElementById('ssCurrentIncome').value
            );
            const workYears = parseInt(document.getElementById('ssWorkYears').value) || 15;
            const startAge = parseInt(document.getElementById('ssEstStartAge').value) || 67;
            const pia = this.ssCalculator.estimatePIA(income, workYears);
            const adjustedMonthly = this.ssCalculator.adjustBenefitForAge(pia, startAge, fra);
            return {
              ssAnnualBenefit: adjustedMonthly * 12,
              ssStartAge: startAge,
            };
          }
        }

        toggleEventsPanel() {
          const panel = document.getElementById('eventsPanel');
          const button = document.getElementById('toggleEvents');
          const isExpanded = panel.classList.toggle('show');
          button.classList.toggle('active');
          button.setAttribute('aria-expanded', isExpanded);
        }

        ensureEventsPanelOpen() {
          const panel = document.getElementById('eventsPanel');
          if (!panel.classList.contains('show')) {
            this.toggleEventsPanel();
          }
        }

        addLifeEvent(eventData = {}) {
          const currentAge = parseInt(document.getElementById('currentAge').value) || 35;
          const event = this.eventsManager.addEvent({
            name: eventData.name || '',
            type: eventData.type || 'expense',
            amount: eventData.amount || 0,
            startAge: eventData.startAge || currentAge + 5,
            duration: eventData.duration || 1,
          });
          this.renderLifeEvents();
        }

        removeLifeEvent(id) {
          this.eventsManager.removeEvent(id);
          this.renderLifeEvents();
        }

        updateLifeEvent(id, field, value) {
          this.eventsManager.updateEvent(id, field, value);
        }

        renderLifeEvents() {
          const container = document.getElementById('eventsList');
          const events = this.eventsManager.getEvents();

          if (events.length === 0) {
            container.innerHTML =
              '<div class="events-empty">No life events added yet. Click "+ Add Event" to get started.</div>';
            return;
          }

          container.innerHTML = '';

          events.forEach((event) => {
            // Escape user input to prevent XSS
            const escapedName = DOMUtils.escapeHtml(event.name);
            const safeAriaLabel = event.name ? `Delete ${escapedName}` : 'Delete this event';

            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.setAttribute('role', 'listitem');
            eventItem.innerHTML = `
                        <div class="event-field">
                            <label for="event-type-${event.id}">Type</label>
                            <select id="event-type-${event.id}" data-id="${event.id}" data-field="type" aria-label="Event type">
                                <option value="expense" ${event.type === 'expense' ? 'selected' : ''}>Expense</option>
                                <option value="income" ${event.type === 'income' ? 'selected' : ''}>Income</option>
                            </select>
                        </div>
                        <div class="event-field">
                            <label for="event-name-${event.id}">Name</label>
                            <input id="event-name-${event.id}" type="text" placeholder="e.g., College costs" data-id="${event.id}" data-field="name" aria-label="Event name">
                        </div>
                        <div class="event-field">
                            <label for="event-amount-${event.id}">Annual Amount ($)</label>
                            <input id="event-amount-${event.id}" type="number" placeholder="0" value="${event.amount}" min="0" step="1000" data-id="${event.id}" data-field="amount" aria-label="Annual amount in dollars">
                        </div>
                        <div class="event-field">
                            <label for="event-age-${event.id}">Start Age</label>
                            <input id="event-age-${event.id}" type="number" placeholder="35" value="${event.startAge}" min="18" max="120" data-id="${event.id}" data-field="startAge" aria-label="Starting age">
                        </div>
                        <div class="event-field">
                            <label for="event-duration-${event.id}">Duration (years)</label>
                            <input id="event-duration-${event.id}" type="number" placeholder="1" value="${event.duration}" min="1" max="50" data-id="${event.id}" data-field="duration" aria-label="Duration in years">
                        </div>
                        <button class="delete-event-btn" data-id="${event.id}" aria-label="${safeAriaLabel}">√ó</button>
                    `;

            // Set the name value safely via DOM property (not innerHTML)
            const nameInput = eventItem.querySelector(`#event-name-${event.id}`);
            if (nameInput) nameInput.value = event.name;

            // Add event listeners to inputs
            eventItem.querySelectorAll('input, select').forEach((input) => {
              input.addEventListener('input', (e) => {
                const id = parseInt(e.target.dataset.id);
                const field = e.target.dataset.field;
                let value = e.target.value;

                if (field === 'amount' || field === 'startAge' || field === 'duration') {
                  value = parseFloat(value) || 0;
                }

                this.updateLifeEvent(id, field, value);
              });
            });

            // Add delete button listener
            eventItem.querySelector('.delete-event-btn').addEventListener('click', (e) => {
              const id = parseInt(e.target.dataset.id);
              this.removeLifeEvent(id);
            });

            container.appendChild(eventItem);
          });
        }

        parseCurrencyValue(value) {
          // Remove all non-numeric characters except decimal point
          const cleaned = String(value).replace(/[^0-9.]/g, '');
          return parseFloat(cleaned) || 0;
        }

        formatCurrencyInput(value) {
          // Format as currency with commas and 2 decimal places
          if (value === undefined || value === null || isNaN(value)) return '$0.00';
          return (
            '$' +
            Number(value)
              .toFixed(2)
              .replace(/\B(?=(\d{3})+(?!\d))/g, ',')
          );
        }

        getInputValues() {
          // Get state tax rate from dropdown
          const stateSelect = document.getElementById('stateSelect');
          const stateCode = stateSelect?.value || '';
          const stateTaxRates = {
            AL: 0.05,
            AK: 0,
            AZ: 0.025,
            AR: 0.044,
            CA: 0.133,
            CO: 0.044,
            CT: 0.0699,
            DE: 0.066,
            FL: 0,
            GA: 0.0549,
            HI: 0.11,
            ID: 0.058,
            IL: 0.0495,
            IN: 0.0305,
            IA: 0.0575,
            KS: 0.057,
            KY: 0.04,
            LA: 0.0425,
            ME: 0.0715,
            MD: 0.0575,
            MA: 0.05,
            MI: 0.0425,
            MN: 0.0985,
            MS: 0.05,
            MO: 0.048,
            MT: 0.059,
            NE: 0.0584,
            NV: 0,
            NH: 0,
            NJ: 0.1075,
            NM: 0.059,
            NY: 0.109,
            NC: 0.0475,
            ND: 0.025,
            OH: 0.035,
            OK: 0.0475,
            OR: 0.099,
            PA: 0.0307,
            RI: 0.0599,
            SC: 0.064,
            SD: 0,
            TN: 0,
            TX: 0,
            UT: 0.0465,
            VT: 0.0875,
            VA: 0.0575,
            WA: 0,
            WV: 0.0512,
            WI: 0.0765,
            WY: 0,
            DC: 0.1075,
          };
          const stateTaxRate = stateTaxRates[stateCode] || 0;

          const baseParams = {
            currentAge: parseInt(document.getElementById('currentAge').value),
            retirementAge: parseInt(document.getElementById('retirementAge').value),
            expectedReturn: parseFloat(document.getElementById('expectedReturn').value),
            returnVolatility: parseFloat(document.getElementById('returnVolatility').value),
            inflationRate: parseFloat(document.getElementById('inflationRate').value),
            annualSpending: this.parseCurrencyValue(
              document.getElementById('annualSpending').value
            ),
            yearsInRetirement: parseInt(document.getElementById('yearsInRetirement').value),
            numSimulations: parseInt(document.getElementById('numSimulations').value),
            advancedMode: this.advancedMode,
            stateCode: stateCode,
            stateTaxRate: stateTaxRate,
            ...this.getSSParams(),
          };

          if (this.advancedMode) {
            // Get account breakdown
            return {
              ...baseParams,
              accounts: {
                traditional401k: this.parseCurrencyValue(
                  document.getElementById('traditional401k').value
                ),
                roth401k: this.parseCurrencyValue(document.getElementById('roth401k').value),
                traditionalIRA: this.parseCurrencyValue(
                  document.getElementById('traditionalIRA').value
                ),
                rothIRA: this.parseCurrencyValue(document.getElementById('rothIRA').value),
                taxable: this.parseCurrencyValue(document.getElementById('taxableBrokerage').value),
              },
              contributions: {
                traditional401k: this.parseCurrencyValue(
                  document.getElementById('contribTraditional401k').value
                ),
                roth401k: this.parseCurrencyValue(document.getElementById('contribRoth401k').value),
                traditionalIRA: this.parseCurrencyValue(
                  document.getElementById('contribTraditionalIRA').value
                ),
                rothIRA: this.parseCurrencyValue(document.getElementById('contribRothIRA').value),
                taxable: this.parseCurrencyValue(document.getElementById('contribTaxable').value),
              },
            };
          } else {
            // Simple mode - use totals
            return {
              ...baseParams,
              currentSavings: this.parseCurrencyValue(
                document.getElementById('currentSavings').value
              ),
              annualContribution: this.parseCurrencyValue(
                document.getElementById('annualContribution').value
              ),
            };
          }
        }

        validateInputs(params) {
          if (params.retirementAge <= params.currentAge) {
            alert('Retirement age must be greater than current age');
            return false;
          }

          if (params.advancedMode) {
            // Check advanced mode values
            const accountValues = Object.values(params.accounts || {});
            const contribValues = Object.values(params.contributions || {});
            if (accountValues.some((v) => v < 0) || contribValues.some((v) => v < 0)) {
              alert('Financial values cannot be negative');
              return false;
            }
          } else {
            if (params.currentSavings < 0 || params.annualContribution < 0) {
              alert('Financial values cannot be negative');
              return false;
            }
          }

          if (params.annualSpending < 0) {
            alert('Annual spending cannot be negative');
            return false;
          }

          if (params.numSimulations < 100) {
            alert('Please run at least 100 simulations for meaningful results');
            return false;
          }

          // Warnings for extreme values (don't block, just inform)
          const warnings = [];
          if (params.expectedReturn > 12) {
            warnings.push(
              `Growth rate of ${params.expectedReturn}% is very optimistic. Historical stock market averages 7-10%.`
            );
          }
          if (params.expectedReturn < 3) {
            warnings.push(
              `Growth rate of ${params.expectedReturn}% is very conservative. Consider if this matches your investment strategy.`
            );
          }
          if (params.returnVolatility > 25) {
            warnings.push(
              `Volatility of ${params.returnVolatility}% is extremely high (typical stocks: 12-18%).`
            );
          }
          if (params.inflationRate > 6) {
            warnings.push(
              `Inflation rate of ${params.inflationRate}% is higher than historical averages (typically 2-4%).`
            );
          }
          if (params.yearsInRetirement > 40) {
            warnings.push(
              `Planning for ${params.yearsInRetirement} years in retirement. Ensure this aligns with your life expectancy.`
            );
          }

          if (warnings.length > 0) {
            const proceed = confirm(
              'Heads up - some inputs are outside typical ranges:\n\n‚Ä¢ ' +
                warnings.join('\n‚Ä¢ ') +
                '\n\nContinue with simulation anyway?'
            );
            if (!proceed) return false;
          }
          return true;
        }

        async runSimulation() {
          const params = this.getInputValues();

          if (!this.validateInputs(params)) {
            return;
          }

          // Disable button and show progress with spinner
          const button = document.getElementById('runSimulation');
          const progress = document.getElementById('progress');
          button.disabled = true;
          button.classList.add('running');
          button.textContent = 'Running...';
          progress.textContent = 'Initializing simulations...';
          document.getElementById('results').classList.remove('show');

          try {
            const lifeEvents = this.eventsManager.getEvents();
            console.log('Simulation params:', params);

            const simulator = new RetirementSimulator(params, lifeEvents, {
              formatCurrency: (v) => FinanceUtils.formatCurrencyCompact(v),
            });

            await simulator.runSimulations((percent) => {
              progress.textContent = `Running simulations: ${percent}%`;
            });

            progress.textContent = 'Calculating results...';

            const stats = simulator.getStatistics();
            console.log('Statistics:', stats);
            this.displayStatistics(stats, params);

            const histogramData = simulator.getHistogramData();
            console.log('Histogram data:', histogramData);
            this.updateHistogram(histogramData);

            console.log('Sample paths count:', simulator.samplePaths?.length);
            if (simulator.samplePaths && simulator.samplePaths.length > 0) {
              this.updatePathsChart(simulator.samplePaths, params);
            }

            // Show gap analysis if success rate is below 90%
            await this.updateGapAnalysis(stats, params);

            document.getElementById('results').classList.add('show');
            progress.textContent = 'Simulation complete!';

            setTimeout(() => {
              progress.textContent = '';
            }, 2000);
          } catch (error) {
            console.error('Simulation error:', error);
            console.error('Error stack:', error.stack);
            progress.textContent = 'Error: ' + error.message;
          } finally {
            button.disabled = false;
            button.classList.remove('running');
            button.textContent = 'Run Simulation';
          }
        }

        displayStatistics(stats, params) {
          const endAge = params.retirementAge + params.yearsInRetirement;
          document.getElementById('successRate').textContent = stats.successRate.toFixed(1) + '%';
          document.getElementById('medianBalance').textContent = this.formatCurrency(stats.median);
          document.getElementById('percentile10').textContent = this.formatCurrency(
            stats.percentile10
          );
          document.getElementById('percentile90').textContent = this.formatCurrency(
            stats.percentile90
          );
          document.getElementById('endAge').textContent = endAge;
        }

        async updateGapAnalysis(stats, params) {
          const gapSection = document.getElementById('gapAnalysis');
          if (!gapSection) return;

          // Only show if success rate is below 90%
          if (stats.successRate >= 90) {
            gapSection.style.display = 'none';
            return;
          }

          gapSection.style.display = 'block';

          // Calculate recommendations
          // Simple binary search to find needed adjustments
          const TARGET_SUCCESS = 90;

          // Option 1: How much more to save monthly
          const currentAnnualSavings = params.annualContribution || 0;
          const neededIncrease = await this.calculateSavingsIncrease(params, TARGET_SUCCESS);
          const monthlyIncrease = neededIncrease / 12;
          document.getElementById('recSaveMore').textContent =
            '+' + FinanceUtils.formatCurrency(monthlyIncrease) + '/mo';

          // Option 2: How many more years to work
          const additionalYears = await this.calculateWorkYears(params, TARGET_SUCCESS);
          document.getElementById('recWorkLonger').textContent = '+' + additionalYears + ' years';

          // Option 3: How much less to spend in retirement
          const spendingReduction = await this.calculateSpendingReduction(params, TARGET_SUCCESS);
          document.getElementById('recSpendLess').textContent =
            '-' + FinanceUtils.formatCurrency(spendingReduction) + '/year';

          // Store recommendations for "Try This" buttons
          window.gapRecommendations = {
            additionalYears,
            spendingReduction,
            currentParams: params,
          };
        }

        async calculateSavingsIncrease(params, targetSuccess) {
          // Binary search for needed savings increase
          let low = 0;
          let high = 100000; // Max $100k/year increase
          const lifeEvents = this.eventsManager.getEvents();

          while (high - low > 100) {
            const mid = Math.floor((low + high) / 2);
            const testParams = { ...params, annualContribution: params.annualContribution + mid };
            const simulator = new RetirementSimulator(testParams, lifeEvents);
            await simulator.runSimulations(() => {});
            const stats = simulator.getStatistics();

            if (stats.successRate >= targetSuccess) {
              high = mid;
            } else {
              low = mid;
            }
          }

          return Math.ceil(high / 1000) * 1000; // Round up to nearest $1000
        }

        async calculateWorkYears(params, targetSuccess) {
          // Try working 1, 2, 3, etc. more years
          const lifeEvents = this.eventsManager.getEvents();

          for (let additionalYears = 1; additionalYears <= 10; additionalYears++) {
            const testParams = { ...params, retirementAge: params.retirementAge + additionalYears };
            const simulator = new RetirementSimulator(testParams, lifeEvents);
            await simulator.runSimulations(() => {});
            const stats = simulator.getStatistics();

            if (stats.successRate >= targetSuccess) {
              return additionalYears;
            }
          }

          return 10; // Cap at 10 years
        }

        async calculateSpendingReduction(params, targetSuccess) {
          // Binary search for needed spending reduction
          let low = 0;
          let high = params.annualSpending * 0.5; // Max 50% reduction
          const lifeEvents = this.eventsManager.getEvents();

          while (high - low > 100) {
            const mid = Math.floor((low + high) / 2);
            const testParams = { ...params, annualSpending: params.annualSpending - mid };
            const simulator = new RetirementSimulator(testParams, lifeEvents);
            await simulator.runSimulations(() => {});
            const stats = simulator.getStatistics();

            if (stats.successRate >= targetSuccess) {
              high = mid;
            } else {
              low = mid;
            }
          }

          return Math.ceil(high / 1000) * 1000; // Round up to nearest $1000
        }

        formatCurrency(value) {
          return FinanceUtils.formatCurrencyCompact(value);
        }

        downloadChart(canvasId, filename) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;

          // Create a temporary canvas with white background
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = canvas.width;
          tempCanvas.height = canvas.height;
          const tempCtx = tempCanvas.getContext('2d');

          // Fill with white background
          tempCtx.fillStyle = '#ffffff';
          tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

          // Draw the chart on top
          tempCtx.drawImage(canvas, 0, 0);

          // Create download link
          const link = document.createElement('a');
          link.download = filename;
          link.href = tempCanvas.toDataURL('image/png');
          link.click();
        }

        updateHistogram(histogramData) {
          if (typeof Chart === 'undefined') {
            console.error('Chart.js failed to load. Charts will not be displayed.');
            return;
          }
          const ctx = document.getElementById('histogramChart').getContext('2d');

          if (this.histogramChart) {
            this.histogramChart.destroy();
          }

          this.histogramChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: histogramData.labels,
              datasets: [
                {
                  label: 'Number of Simulations',
                  data: histogramData.data,
                  backgroundColor: 'rgba(102, 126, 234, 0.7)',
                  borderColor: 'rgba(102, 126, 234, 1)',
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  callbacks: {
                    title: function (context) {
                      return 'Balance Range: ' + context[0].label;
                    },
                    label: function (context) {
                      return 'Simulations: ' + context.parsed.y;
                    },
                  },
                },
              },
              scales: {
                x: {
                  title: {
                    display: true,
                    text: 'Ending Balance',
                  },
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: 'Frequency',
                  },
                  beginAtZero: true,
                },
              },
            },
          });

          // Populate accessible data table
          const tableDiv = document.getElementById('histogramDataTable');
          let tableHtml =
            '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="text-align: left; padding: 4px; border-bottom: 1px solid #ddd;">Balance Range</th><th style="text-align: right; padding: 4px; border-bottom: 1px solid #ddd;">Simulations</th></tr></thead><tbody>';
          histogramData.labels.forEach((label, i) => {
            tableHtml += `<tr><td style="padding: 4px;">${label}</td><td style="text-align: right; padding: 4px;">${histogramData.data[i]}</td></tr>`;
          });
          tableHtml += '</tbody></table>';
          tableDiv.innerHTML = tableHtml;
        }

        updatePathsChart(paths, params) {
          if (typeof Chart === 'undefined') {
            console.error('Chart.js failed to load. Charts will not be displayed.');
            return;
          }
          const ctx = document.getElementById('pathsChart').getContext('2d');

          if (this.pathsChart) {
            this.pathsChart.destroy();
          }

          // Safety check
          if (!paths || paths.length === 0 || !paths[0] || paths[0].length === 0) {
            console.error('No path data available for chart');
            return;
          }

          // Calculate percentile bands at each age point
          // Find the maximum path length
          const maxPathLength = Math.max(...paths.map((p) => p.length));

          const percentile10 = [];
          const percentile25 = [];
          const percentile50 = [];
          const percentile75 = [];
          const percentile90 = [];

          for (let i = 0; i < maxPathLength; i++) {
            // Collect balances from all paths that have data at this index
            const balancesAtAge = paths
              .filter((path) => i < path.length)
              .map((path) => path[i].balance)
              .sort((a, b) => a - b);

            const n = balancesAtAge.length;

            // Skip if we don't have enough data points
            if (n === 0) continue;

            const age = paths[0][i]?.age;
            if (!age) continue;

            percentile10.push({ x: age, y: balancesAtAge[Math.floor(n * 0.1)] });
            percentile25.push({ x: age, y: balancesAtAge[Math.floor(n * 0.25)] });
            percentile50.push({ x: age, y: balancesAtAge[Math.floor(n * 0.5)] });
            percentile75.push({ x: age, y: balancesAtAge[Math.floor(n * 0.75)] });
            percentile90.push({ x: age, y: balancesAtAge[Math.floor(n * 0.9)] });
          }

          // Create datasets for confidence bands
          const datasets = [
            // 10th-90th percentile band (light)
            {
              label: '10th-90th Percentile Range',
              data: percentile90,
              fill: '+1',
              backgroundColor: 'rgba(102, 126, 234, 0.15)',
              borderColor: 'rgba(102, 126, 234, 0.3)',
              borderWidth: 1,
              pointRadius: 0,
              tension: 0.2,
              order: 4,
            },
            {
              label: '10th Percentile',
              data: percentile10,
              fill: false,
              backgroundColor: 'transparent',
              borderColor: 'rgba(102, 126, 234, 0.3)',
              borderWidth: 1,
              pointRadius: 0,
              tension: 0.2,
              order: 3,
            },
            // 25th-75th percentile band (darker)
            {
              label: '25th-75th Percentile Range',
              data: percentile75,
              fill: '+1',
              backgroundColor: 'rgba(102, 126, 234, 0.25)',
              borderColor: 'rgba(102, 126, 234, 0.5)',
              borderWidth: 1,
              pointRadius: 0,
              tension: 0.2,
              order: 2,
            },
            {
              label: '25th Percentile',
              data: percentile25,
              fill: false,
              backgroundColor: 'transparent',
              borderColor: 'rgba(102, 126, 234, 0.5)',
              borderWidth: 1,
              pointRadius: 0,
              tension: 0.2,
              order: 1,
            },
            // Median line (bold)
            {
              label: 'Median (50th Percentile)',
              data: percentile50,
              fill: false,
              backgroundColor: 'transparent',
              borderColor: '#667eea',
              borderWidth: 3,
              pointRadius: 0,
              tension: 0.2,
              order: 0,
            },
            // $0 threshold line (depletion risk indicator)
            {
              label: '$0 Threshold',
              data:
                percentile50.length > 0
                  ? [
                      { x: percentile50[0].x, y: 0 },
                      { x: percentile50[percentile50.length - 1].x, y: 0 },
                    ]
                  : [],
              fill: false,
              backgroundColor: 'transparent',
              borderColor: 'rgba(220, 53, 69, 0.7)',
              borderWidth: 2,
              borderDash: [8, 4],
              pointRadius: 0,
              tension: 0,
              order: 5,
            },
          ];

          this.pathsChart = new Chart(ctx, {
            type: 'line',
            data: {
              datasets: datasets,
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top',
                  labels: {
                    usePointStyle: false,
                    boxWidth: 40,
                    padding: 15,
                    font: {
                      size: 13,
                      weight: '500',
                    },
                    filter: function (legendItem, chartData) {
                      // Show median, range items, and threshold
                      return (
                        legendItem.text.includes('Median') ||
                        legendItem.text.includes('Range') ||
                        legendItem.text.includes('Threshold')
                      );
                    },
                    generateLabels: function (chart) {
                      const original = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                      return original.filter((item) => {
                        return (
                          item.text.includes('Median') ||
                          item.text.includes('Range') ||
                          item.text.includes('Threshold')
                        );
                      });
                    },
                  },
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  callbacks: {
                    title: function (context) {
                      return `Age ${Math.round(context[0].parsed.x)}`;
                    },
                    label: function (context) {
                      // Don't show range datasets or threshold in tooltip
                      if (
                        context.dataset.label.includes('Range') ||
                        context.dataset.label.includes('Threshold')
                      ) {
                        return null;
                      }
                      return `${context.dataset.label}: ${this.formatCurrency(context.parsed.y)}`;
                    }.bind(this),
                  },
                },
              },
              scales: {
                x: {
                  type: 'linear',
                  title: {
                    display: true,
                    text: 'Age',
                    font: {
                      size: 14,
                      weight: 'bold',
                    },
                  },
                  ticks: {
                    stepSize: 5,
                    font: {
                      size: 12,
                    },
                  },
                },
                y: {
                  title: {
                    display: true,
                    text: 'Portfolio Balance ($)',
                    font: {
                      size: 14,
                      weight: 'bold',
                    },
                  },
                  ticks: {
                    font: {
                      size: 12,
                    },
                    callback: function (value) {
                      return this.formatCurrency(value);
                    }.bind(this),
                  },
                },
              },
              interaction: {
                mode: 'index',
                intersect: false,
              },
            },
          });

          // Populate accessible data table for paths chart
          const pathsTableDiv = document.getElementById('pathsDataTable');
          const medianDataset = datasets.find((d) => d.label === 'Median (50th Percentile)');
          if (medianDataset && medianDataset.data) {
            let tableHtml =
              '<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="text-align: left; padding: 4px; border-bottom: 1px solid #ddd;">Age</th><th style="text-align: right; padding: 4px; border-bottom: 1px solid #ddd;">Median Balance</th></tr></thead><tbody>';
            // Show every 5 years to keep table readable
            medianDataset.data.forEach((point, i) => {
              if (i % 5 === 0 || i === medianDataset.data.length - 1) {
                tableHtml += `<tr><td style="padding: 4px;">${Math.round(point.x)}</td><td style="text-align: right; padding: 4px;">${this.formatCurrency(point.y)}</td></tr>`;
              }
            });
            tableHtml += '</tbody></table>';
            pathsTableDiv.innerHTML = tableHtml;
          }
        }
      }

      // Map ZIP code to two-letter state code
      function zipToStateCode(zipCode) {
        if (!zipCode || zipCode.length !== 5) return '';
        const zip = parseInt(zipCode);
        if (isNaN(zip)) return '';

        const ranges = [
          [35000, 36999, 'AL'],
          [99500, 99950, 'AK'],
          [85000, 86599, 'AZ'],
          [71600, 72999, 'AR'],
          [90000, 96199, 'CA'],
          [80000, 81699, 'CO'],
          [6000, 6999, 'CT'],
          [19700, 19999, 'DE'],
          [32000, 34999, 'FL'],
          [30000, 31999, 'GA'],
          [96700, 96899, 'HI'],
          [83200, 83899, 'ID'],
          [60000, 62999, 'IL'],
          [46000, 47999, 'IN'],
          [50000, 52899, 'IA'],
          [66000, 67999, 'KS'],
          [40000, 42799, 'KY'],
          [70000, 71499, 'LA'],
          [3900, 4999, 'ME'],
          [20600, 21999, 'MD'],
          [1000, 2799, 'MA'],
          [48000, 49999, 'MI'],
          [55000, 56799, 'MN'],
          [38600, 39799, 'MS'],
          [63000, 65899, 'MO'],
          [59000, 59999, 'MT'],
          [68000, 69399, 'NE'],
          [89000, 89899, 'NV'],
          [3000, 3899, 'NH'],
          [7000, 8999, 'NJ'],
          [87000, 88499, 'NM'],
          [10000, 14999, 'NY'],
          [27000, 28999, 'NC'],
          [58000, 58899, 'ND'],
          [43000, 45999, 'OH'],
          [73000, 74999, 'OK'],
          [97000, 97999, 'OR'],
          [15000, 19699, 'PA'],
          [2800, 2999, 'RI'],
          [29000, 29999, 'SC'],
          [57000, 57799, 'SD'],
          [37000, 38599, 'TN'],
          [75000, 79999, 'TX'],
          [88500, 88599, 'TX'],
          [84000, 84799, 'UT'],
          [5000, 5999, 'VT'],
          [22000, 24699, 'VA'],
          [98000, 99499, 'WA'],
          [24700, 26899, 'WV'],
          [53000, 54999, 'WI'],
          [82000, 83199, 'WY'],
          [20000, 20599, 'DC'],
        ];

        for (const [lo, hi, code] of ranges) {
          if (zip >= lo && zip <= hi) return code;
        }
        return '';
      }

      // Initialize the application
      const ui = new SimulatorUI();

      // Load data from other pages if available
      DOMUtils.ready(() => {
        // Load saved retirement forecast settings first
        const savedForecast = StorageUtils.get('retirementForecastData');
        if (savedForecast) {
          // Restore all input fields
          if (savedForecast.currentAge)
            document.getElementById('currentAge').value = savedForecast.currentAge;
          if (savedForecast.retirementAge)
            document.getElementById('retirementAge').value = savedForecast.retirementAge;
          if (savedForecast.currentSavings)
            document.getElementById('currentSavings').value = ui.formatCurrencyInput(
              savedForecast.currentSavings
            );
          if (savedForecast.annualContribution)
            document.getElementById('annualContribution').value = ui.formatCurrencyInput(
              savedForecast.annualContribution
            );
          if (savedForecast.expectedReturn)
            document.getElementById('expectedReturn').value = savedForecast.expectedReturn;
          if (savedForecast.returnVolatility)
            document.getElementById('returnVolatility').value = savedForecast.returnVolatility;
          if (savedForecast.inflationRate)
            document.getElementById('inflationRate').value = savedForecast.inflationRate;
          if (savedForecast.annualSpending)
            document.getElementById('annualSpending').value = ui.formatCurrencyInput(
              savedForecast.annualSpending
            );
          if (savedForecast.yearsInRetirement)
            document.getElementById('yearsInRetirement').value = savedForecast.yearsInRetirement;
          if (savedForecast.numSimulations)
            document.getElementById('numSimulations').value = savedForecast.numSimulations;
          if (savedForecast.stateCode) {
            const stateSelect = document.getElementById('stateSelect');
            if (stateSelect) stateSelect.value = savedForecast.stateCode;
          }
        }

        // Pre-populate state from Budget Planner zip code if not already set by saved forecast
        if (!savedForecast || !savedForecast.stateCode) {
          const budgetPlannerData = StorageUtils.get('budgetPlannerData');
          if (budgetPlannerData && budgetPlannerData.zipCode) {
            const stateCode = zipToStateCode(budgetPlannerData.zipCode);
            if (stateCode) {
              const stateSelect = document.getElementById('stateSelect');
              if (stateSelect) stateSelect.value = stateCode;
            }
          }
        }

        // Load saved life events
        const savedLifeEvents = StorageUtils.get('lifeEventsData', []);
        if (savedLifeEvents.length > 0) {
          // Expand the life events panel
          document.getElementById('eventsPanel').classList.add('show');
          document.getElementById('toggleEvents').classList.add('active');
          document.getElementById('toggleEvents').setAttribute('aria-expanded', 'true');

          // Add each saved life event
          savedLifeEvents.forEach((event) => {
            ui.addLifeEvent(event);
          });
        }

        // Load income from Budget Planner for SS estimation
        const budgetPlannerData = StorageUtils.get('budgetPlannerData');
        if (budgetPlannerData && budgetPlannerData.monthlyIncome) {
          const annualIncome = budgetPlannerData.monthlyIncome * 12;
          const ssIncomeInput = document.getElementById('ssCurrentIncome');
          if (ssIncomeInput) {
            ssIncomeInput.value = ui.formatCurrencyInput(annualIncome);
            ui.updateEstimatedSSBenefit();
          }
        }

        // Try to load from Spending Tracker data (for spending/contribution if not saved)
        if (!savedForecast) {
          const spendingData = StorageUtils.get('spendingTrackerData');
          if (spendingData) {
            // Update Annual Spending in Retirement
            const annualSpending = spendingData.monthlySpending * 12;
            const spendingInput = document.getElementById('annualSpending');
            if (spendingInput && annualSpending > 0) {
              spendingInput.value = ui.formatCurrencyInput(annualSpending);
            }

            // Update Annual Contribution
            const contribution = spendingData.monthlyRetirementSavings * 12;
            const contributionInput = document.getElementById('annualContribution');
            if (contributionInput && contribution > 0) {
              contributionInput.value = ui.formatCurrencyInput(contribution);
            }
          } else {
            // Fall back to Budget Planner data
            const budgetData = StorageUtils.get('budgetRetirementData');
            if (budgetData && budgetData.annualContribution > 0) {
              const contributionInput = document.getElementById('annualContribution');
              if (contributionInput) {
                contributionInput.value = ui.formatCurrencyInput(budgetData.annualContribution);
              }
            }
          }
        }

        // Initialize session toolbar
        SessionManager.initToolbar(
          // Get current page data for export
          () => {
            const params = ui.getInputValues();
            const lifeEvents = ui.eventsManager.getEvents();

            // Capture Social Security settings
            const ssSettings = {
              mode: ui.ssMode,
              knownBenefit: ui.parseCurrencyValue(
                document.getElementById('ssMonthlyBenefit')?.value || '0'
              ),
              knownStartAge: parseInt(document.getElementById('ssStartAge')?.value) || 67,
              estIncome: ui.parseCurrencyValue(
                document.getElementById('ssCurrentIncome')?.value || '0'
              ),
              estWorkYears: parseInt(document.getElementById('ssWorkYears')?.value) || 15,
              estStartAge: parseInt(document.getElementById('ssEstStartAge')?.value) || 67,
            };

            // Save current state to localStorage for other pages
            StorageUtils.set('retirementForecastData', params);
            StorageUtils.set('lifeEventsData', lifeEvents);
            StorageUtils.set('ssSettingsData', ssSettings);

            return {
              retirementForecast: params,
              lifeEvents: lifeEvents,
              ssSettings: ssSettings,
            };
          },
          // Handle import - update UI directly to reflect changes
          (result) => {
            // Helper to set input value and trigger event
            const setInputValue = (id, value, formatter = null) => {
              const el = document.getElementById(id);
              if (el && value !== undefined && value !== null) {
                el.value = formatter ? formatter(value) : value;
                el.dispatchEvent(new Event('input', { bubbles: true }));
                return true;
              }
              return false;
            };

            // Reload saved retirement forecast data and update UI
            const savedForecast = StorageUtils.get('retirementForecastData');
            let forecastUpdated = false;

            if (savedForecast) {
              // Restore basic input fields
              forecastUpdated =
                setInputValue('currentAge', savedForecast.currentAge) || forecastUpdated;
              forecastUpdated =
                setInputValue('retirementAge', savedForecast.retirementAge) || forecastUpdated;
              forecastUpdated =
                setInputValue('expectedReturn', savedForecast.expectedReturn) || forecastUpdated;
              forecastUpdated =
                setInputValue('returnVolatility', savedForecast.returnVolatility) ||
                forecastUpdated;
              forecastUpdated =
                setInputValue('inflationRate', savedForecast.inflationRate) || forecastUpdated;
              forecastUpdated =
                setInputValue(
                  'annualSpending',
                  savedForecast.annualSpending,
                  ui.formatCurrencyInput.bind(ui)
                ) || forecastUpdated;
              forecastUpdated =
                setInputValue('yearsInRetirement', savedForecast.yearsInRetirement) ||
                forecastUpdated;
              forecastUpdated =
                setInputValue('numSimulations', savedForecast.numSimulations) || forecastUpdated;

              // Handle mode switching and account restoration
              if (savedForecast.advancedMode && savedForecast.accounts) {
                // Switch to advanced mode explicitly
                ui.advancedMode = true;
                const simpleBtn = document.getElementById('simpleModeBtn');
                const advancedBtn = document.getElementById('advancedModeBtn');
                const simpleInputs = document.getElementById('simpleInputs');
                const advancedInputs = document.getElementById('advancedInputs');

                advancedBtn.classList.add('active');
                advancedBtn.setAttribute('aria-selected', 'true');
                simpleBtn.classList.remove('active');
                simpleBtn.setAttribute('aria-selected', 'false');
                simpleInputs.style.display = 'none';
                advancedInputs.style.display = 'block';

                // Restore account balances
                setInputValue(
                  'traditional401k',
                  savedForecast.accounts.traditional401k,
                  ui.formatCurrencyInput.bind(ui)
                );
                setInputValue(
                  'roth401k',
                  savedForecast.accounts.roth401k,
                  ui.formatCurrencyInput.bind(ui)
                );
                setInputValue(
                  'traditionalIRA',
                  savedForecast.accounts.traditionalIRA,
                  ui.formatCurrencyInput.bind(ui)
                );
                setInputValue(
                  'rothIRA',
                  savedForecast.accounts.rothIRA,
                  ui.formatCurrencyInput.bind(ui)
                );
                setInputValue(
                  'taxableBrokerage',
                  savedForecast.accounts.taxable,
                  ui.formatCurrencyInput.bind(ui)
                );

                // Restore contributions
                if (savedForecast.contributions) {
                  setInputValue(
                    'contribTraditional401k',
                    savedForecast.contributions.traditional401k,
                    ui.formatCurrencyInput.bind(ui)
                  );
                  setInputValue(
                    'contribRoth401k',
                    savedForecast.contributions.roth401k,
                    ui.formatCurrencyInput.bind(ui)
                  );
                  setInputValue(
                    'contribTraditionalIRA',
                    savedForecast.contributions.traditionalIRA,
                    ui.formatCurrencyInput.bind(ui)
                  );
                  setInputValue(
                    'contribRothIRA',
                    savedForecast.contributions.rothIRA,
                    ui.formatCurrencyInput.bind(ui)
                  );
                  setInputValue(
                    'contribTaxable',
                    savedForecast.contributions.taxable,
                    ui.formatCurrencyInput.bind(ui)
                  );
                }

                // Update totals display
                ui.updateAdvancedTotals();
                forecastUpdated = true;
              } else {
                // Simple mode
                forecastUpdated =
                  setInputValue(
                    'currentSavings',
                    savedForecast.currentSavings,
                    ui.formatCurrencyInput.bind(ui)
                  ) || forecastUpdated;
                forecastUpdated =
                  setInputValue(
                    'annualContribution',
                    savedForecast.annualContribution,
                    ui.formatCurrencyInput.bind(ui)
                  ) || forecastUpdated;
              }
            }

            // Load saved life events
            const savedLifeEvents = StorageUtils.get('lifeEventsData', []);
            if (savedLifeEvents.length > 0) {
              // Clear existing life events first
              ui.eventsManager.events = [];
              document.getElementById('eventsList').innerHTML = '';

              // Expand the life events panel
              document.getElementById('eventsPanel').classList.add('show');
              document.getElementById('toggleEvents').classList.add('active');
              document.getElementById('toggleEvents').setAttribute('aria-expanded', 'true');

              // Add each saved life event
              savedLifeEvents.forEach((event) => {
                ui.addLifeEvent(event);
              });
            }

            // Restore Social Security settings
            const savedSS = StorageUtils.get('ssSettingsData');
            let ssRestored = false;
            if (savedSS) {
              // Restore SS mode
              const ssNoneBtn = document.getElementById('ssNoneBtn');
              const ssKnownBtn = document.getElementById('ssKnownBtn');
              const ssEstimateBtn = document.getElementById('ssEstimateBtn');
              const ssKnownInputs = document.getElementById('ssKnownInputs');
              const ssEstimateInputs = document.getElementById('ssEstimateInputs');

              // Clear active states
              [ssNoneBtn, ssKnownBtn, ssEstimateBtn].forEach((btn) =>
                btn?.classList.remove('active')
              );
              ssKnownInputs?.classList.remove('show');
              ssEstimateInputs?.classList.remove('show');

              // Set the saved mode
              ui.ssMode = savedSS.mode || 'none';

              if (savedSS.mode === 'known') {
                ssKnownBtn?.classList.add('active');
                ssKnownInputs?.classList.add('show');
                setInputValue(
                  'ssMonthlyBenefit',
                  savedSS.knownBenefit,
                  ui.formatCurrencyInput.bind(ui)
                );
                setInputValue('ssStartAge', savedSS.knownStartAge);
                ui.updateKnownSSBenefit();
                ssRestored = true;
              } else if (savedSS.mode === 'estimate') {
                ssEstimateBtn?.classList.add('active');
                ssEstimateInputs?.classList.add('show');
                setInputValue(
                  'ssCurrentIncome',
                  savedSS.estIncome,
                  ui.formatCurrencyInput.bind(ui)
                );
                setInputValue('ssWorkYears', savedSS.estWorkYears);
                setInputValue('ssEstStartAge', savedSS.estStartAge);
                ui.updateEstimatedSSBenefit();
                ssRestored = true;
              } else {
                ssNoneBtn?.classList.add('active');
              }
            }

            if (forecastUpdated || savedLifeEvents.length > 0 || ssRestored) {
              SessionManager.showToast('Retirement forecast restored!', 'success');
            } else {
              // Fallback to reload if no data found
              window.location.reload();
            }
          }
        );

        // Initialize status bar
        if (typeof StatusBar !== 'undefined') {
          StatusBar.init();
        }

        // Real return display - updates when growth or inflation changes
        function updateRealReturn() {
          const growth = parseFloat(document.getElementById('expectedReturn').value) || 0;
          const inflation = parseFloat(document.getElementById('inflationRate').value) || 0;
          const realReturn = (growth - inflation).toFixed(1);
          document.getElementById('realReturnValue').textContent = realReturn;
        }

        // Initial calculation
        updateRealReturn();

        // Listen for changes
        document.getElementById('expectedReturn').addEventListener('input', updateRealReturn);
        document.getElementById('inflationRate').addEventListener('input', updateRealReturn);

        // Investment strategy presets
        const presets = {
          conservative: { growth: 5, volatility: 8, label: 'Mostly bonds, some stocks' },
          balanced: { growth: 7, volatility: 12, label: '60/40 stocks/bonds mix' },
          aggressive: { growth: 9, volatility: 18, label: 'Mostly stocks' },
        };

        function applyPreset(presetName) {
          const preset = presets[presetName];
          if (!preset) return;

          document.getElementById('expectedReturn').value = preset.growth;
          document.getElementById('returnVolatility').value = preset.volatility;
          updateRealReturn();

          // Update button states
          document.querySelectorAll('.preset-btn').forEach((btn) => {
            btn.style.background = 'white';
            btn.style.color = '#667eea';
          });
          const activeBtn = document.getElementById(
            'preset' + presetName.charAt(0).toUpperCase() + presetName.slice(1)
          );
          if (activeBtn) {
            activeBtn.style.background = '#667eea';
            activeBtn.style.color = 'white';
          }
        }

        document
          .getElementById('presetConservative')
          .addEventListener('click', () => applyPreset('conservative'));
        document
          .getElementById('presetBalanced')
          .addEventListener('click', () => applyPreset('balanced'));
        document
          .getElementById('presetAggressive')
          .addEventListener('click', () => applyPreset('aggressive'));
      });

      // Global functions for gap analysis "Try This" buttons (exposed on window for onclick attributes)
      window.applyWorkLongerRecommendation = function () {
        if (!window.gapRecommendations) return;

        const newRetirementAge =
          window.gapRecommendations.currentParams.retirementAge +
          window.gapRecommendations.additionalYears;

        document.getElementById('retirementAge').value = newRetirementAge;
        document.getElementById('retirementAge').dispatchEvent(new Event('input'));

        // Re-run simulation
        document.getElementById('runSimulation').click();

        // Scroll to top to see new results
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      window.applySpendLessRecommendation = function () {
        if (!window.gapRecommendations) return;

        const newSpending =
          window.gapRecommendations.currentParams.annualSpending -
          window.gapRecommendations.spendingReduction;

        document.getElementById('annualSpending').value = FinanceUtils.formatCurrency(newSpending);
        document.getElementById('annualSpending').dispatchEvent(new Event('input'));

        // Re-run simulation
        document.getElementById('runSimulation').click();

        // Scroll to top to see new results
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
    </script>
  </body>
</html>
